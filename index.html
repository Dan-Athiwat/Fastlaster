<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NextGen V10.0 (Screen Share)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #007AFF; --bg: #000; --surface: #1c1c1e; --text: #fff; --danger: #ff3b30; --success: #2ed573; --warn: #f1c40f; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        .btn { border: none; border-radius: 12px; padding: 12px; cursor: pointer; font-weight: 600; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; color: white; transition: 0.2s; font-size: 1rem; }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid #555; color: white; width: auto; padding: 8px 12px; font-size: 0.9rem; }
        
        input { width: 100%; padding: 14px; background: #2c2c2e; border: 1px solid #444; border-radius: 10px; color: white; outline: none; margin-bottom: 15px; font-size: 1rem; }

        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; background: var(--bg); }
        .screen.active { display: flex; }

        /* Auth */
        .center-wrap { justify-content: center; align-items: center; background: radial-gradient(circle at center, #222 0%, #000 100%); padding: 20px; }
        .card { width: 100%; max-width: 400px; background: rgba(30,30,30,0.95); padding: 30px; border-radius: 20px; text-align: center; border: 1px solid #333; }
        .link-text { margin-top: 20px; color: var(--primary); cursor: pointer; text-decoration: underline; display: inline-block; padding: 10px; }

        /* Dashboard */
        #ui-dash { flex-direction: row; }
        .sidebar { width: 320px; background: var(--surface); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #333; z-index: 20; overflow-y: auto; }
        .main-area { flex: 1; background: var(--bg); position: relative; display: flex; align-items: center; justify-content: center; }
        .mobile-header { display: none; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mobile-back { display: none; position: absolute; top: 20px; left: 20px; font-size: 1.5rem; cursor: pointer; z-index: 30; }

        .profile-sec { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .avatar-box { position: relative; width: 100px; height: 100px; margin: 0 auto 10px; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        .edit-pic-btn { position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #1c1c1e; }

        .room-item { background: #2a2a2a; padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }

        /* Video UI */
        #ui-video { background: #000; flex-direction: column; }
        .video-grid { flex: 1; width: 100%; height: 100%; display: grid; gap: 2px; padding: 2px; background: #000; }
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; } 
        
        .vid-box { position: relative; width: 100%; height: 100%; background: #111; overflow: hidden; }
        .vid-player { width: 100%; height: 100%; object-fit: cover; }
        .vid-player.screen-share { object-fit: contain; background: #1a1a1a; } /* Fit screen share */

        .cam-off-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            background: #1a1a1a; z-index: 5;
        }
        .cam-off-ui.active { display: flex; }
        .off-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid #555; }

        /* Room ID Badge */
        .room-badge {
            position: absolute; top: 20px; left: 20px; z-index: 50;
            background: rgba(0,0,0,0.6); color: white; border: 1px solid #555;
            padding: 8px 15px; border-radius: 20px; font-weight: bold;
            display: flex; align-items: center; gap: 8px;
        }

        /* Controls */
        .controls { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 15px; background: rgba(30,30,30,0.9); 
            padding: 12px 25px; border-radius: 50px; z-index: 50; 
            backdrop-filter: blur(10px); border: 1px solid #444; 
        }
        .c-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: #444; color: white; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .c-btn.active { background: white; color: black; }
        .c-btn.off { background: rgba(255,59,48,0.2); color: var(--danger); }
        .c-btn.hangup { background: var(--danger); width: 60px; }

        @media (max-width: 768px) {
            #ui-dash { flex-direction: column; }
            .sidebar { width: 100%; height: auto; border: none; padding: 15px; }
            .main-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: translateX(100%); transition: 0.3s; z-index: 30; }
            .main-area.show { transform: translateX(0); }
            .mobile-header { display: flex; }
            .mobile-back { display: block; }
            .grid-2 { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
        }
        @media (min-width: 769px) {
            .grid-2 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; }
        }
    </style>
</head>
<body>

    <div id="ui-login" class="screen center-wrap">
        <div class="card">
            <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2><br>
            <input type="text" id="l-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="tel" id="l-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
            <button class="btn btn-primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <div class="link-text" onclick="go('register')">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</div>
        </div>
    </div>

    <div id="ui-register" class="screen center-wrap">
        <div class="card">
            <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</h2>
            <input type="text" id="r-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)">
            <input type="tel" id="r-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
            <button class="btn btn-primary" onclick="register()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            <div class="link-text" onclick="go('login')">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
        </div>
    </div>

    <div id="ui-dash" class="screen">
        <div class="sidebar">
            <div class="mobile-header">
                <h3>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
                <button class="btn btn-primary" onclick="toggleJoin(true)"><i class="fas fa-video"></i></button>
            </div>

            <div class="profile-sec">
                <div class="avatar-box">
                    <img id="u-pic" src="" class="avatar">
                    <label for="file-upload" class="edit-pic-btn"><i class="fas fa-camera" style="font-size:0.8rem;"></i></label>
                    <input type="file" id="file-upload" hidden accept="image/*" onchange="updateProfilePic(this)">
                </div>
                <h3 id="u-name">User</h3>
                <p id="u-phone" style="color:#888; font-size:0.9rem;">...</p>
                
                <div style="display:flex; gap:8px; justify-content:center; margin-top:15px;">
                    <button class="btn btn-outline btn-sm" onclick="editName()"><i class="fas fa-pen"></i> ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠</button>
                    <button class="btn btn-danger btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <h4 style="color:#888; margin-bottom:10px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡πâ‡∏≠‡∏á</h4>
            <button class="btn btn-primary" onclick="createRoom()">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
            <div id="room-list" style="margin-top:10px;"></div>
        </div>

        <div id="dash-main" class="main-area">
            <div class="mobile-back" onclick="toggleJoin(false)"><i class="fas fa-arrow-left"></i></div>
            <div class="card">
                <i class="fas fa-video" style="font-size:3rem; margin-bottom:20px; color:#555;"></i>
                <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</h3>
                <p style="color:#888; margin-bottom:20px;">‡πÉ‡∏™‡πà Room ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</p>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="join-id" placeholder="Room ID" style="margin-bottom:0;">
                    <button class="btn btn-primary" style="width:80px;" onclick="joinFromInput()">Go</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ui-video" class="screen">
        <div class="room-badge">
            <i class="fas fa-hashtag" style="color:var(--primary)"></i> 
            ID: <span id="display-room-id">--</span>
        </div>
        
        <div id="video-grid" class="video-grid grid-1"></div>

        <div class="controls">
            <button class="c-btn active" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button class="c-btn active" id="btn-cam" onclick="toggleCam()"><i class="fas fa-video"></i></button>
            <button class="c-btn active" id="btn-vol" onclick="toggleSpeaker()"><i class="fas fa-volume-up"></i></button>
            <button class="c-btn off" id="btn-screen" onclick="toggleScreenShare()"><i class="fas fa-desktop"></i></button>
            
            <button class="c-btn hangup" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script>
        // ==========================
        // ‚öôÔ∏è CONFIGURATION
        // ==========================
        const APP_ID = "ebab3ce9350a43c4bf6fb4312a3dbd23"; 

        let client = AgoraRTC.createClient({ mode: "rtc", codec: "h264" });
        let local = { a:null, v:null, s:null }; // s = screen
        let remoteUsers = {};
        let me = null;
        let isCamOn = true;
        let isScreenOn = false;
        let isSpeakerOn = true;

        // --- NAVIGATION ---
        function go(s) { 
            document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')); 
            document.getElementById('ui-'+s).classList.add('active'); 
        }

        window.onload = () => {
            const saved = localStorage.getItem('me');
            if(saved) {
                try { me = JSON.parse(saved); renderMe(); renderHistory(); go('dash'); } 
                catch(e) { localStorage.removeItem('me'); go('login'); }
            } else { go('login'); }
        };

        function toggleJoin(show) { document.getElementById('dash-main').classList.toggle('show', show); }

        // --- AUTH & PROFILE ---
        function login() {
            const n = document.getElementById('l-name').value.trim();
            const p = document.getElementById('l-phone').value.trim();
            let db = JSON.parse(localStorage.getItem('db')||"[]");
            const u = db.find(x=>x.n===n && x.p===p);
            if(u) { me=u; localStorage.setItem('me',JSON.stringify(me)); renderMe(); renderHistory(); go('dash'); }
            else alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
        function register() {
            const n = document.getElementById('r-name').value.trim();
            const p = document.getElementById('r-phone').value.trim();
            if(!n||!p) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            let db = JSON.parse(localStorage.getItem('db')||"[]");
            if(db.find(u=>u.n===n)) return alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥");
            const newUser = { id: Date.now().toString(), n, p, pic: 'https://via.placeholder.com/150', nameChange: 0 };
            db.push(newUser); localStorage.setItem('db',JSON.stringify(db));
            alert("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); go('login');
        }
        function logout() { localStorage.removeItem('me'); location.reload(); }

        function renderMe() {
            document.getElementById('u-name').innerText = me.n;
            document.getElementById('u-phone').innerText = me.p;
            if(me.pic) document.getElementById('u-pic').src = me.pic;
        }
        function updateProfilePic(input) {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = ev => { me.pic = ev.target.result; saveUserData(); renderMe(); };
                r.readAsDataURL(input.files[0]);
            }
        }
        function editName() {
            const now = Date.now();
            const cooldown = 7 * 24 * 60 * 60 * 1000;
            if (now - (me.nameChange||0) < cooldown) return alert("‡∏£‡∏≠‡∏Ñ‡∏£‡∏ö 7 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà");
            const newName = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:");
            if (newName && newName.trim()) { me.n = newName; me.nameChange = now; saveUserData(); renderMe(); }
        }
        function saveUserData() {
            localStorage.setItem('me', JSON.stringify(me));
            let db = JSON.parse(localStorage.getItem('db')||"[]");
            const idx = db.findIndex(u => u.id === me.id);
            if(idx > -1) { db[idx] = me; localStorage.setItem('db', JSON.stringify(db)); }
        }

        // --- ROOMS ---
        function createRoom() {
            const id = Math.floor(1000+Math.random()*9000).toString();
            saveRoomHistory(id); joinRoom(id);
        }
        function joinFromInput() { const v=document.getElementById('join-id').value; if(v) joinRoom(v); }
        function saveRoomHistory(id) {
            let rs = JSON.parse(localStorage.getItem('rooms')||"[]");
            rs.unshift({id}); localStorage.setItem('rooms',JSON.stringify(rs)); renderHistory();
        }
        function renderHistory() {
            const list = document.getElementById('room-list'); list.innerHTML='';
            let rs = JSON.parse(localStorage.getItem('rooms')||"[]");
            rs.forEach(r => {
                list.innerHTML += `<div class="room-item"><span>${r.id}</span><button class="btn btn-primary btn-sm" onclick="joinRoom('${r.id}')">Join</button></div>`;
            });
        }

        // --- VIDEO CORE (Fast Toggle Fix) ---
        async function joinRoom(rid) {
            if(APP_ID.length < 10) return alert("‡πÉ‡∏™‡πà App ID ‡∏Å‡πà‡∏≠‡∏ô");
            go('video'); 
            document.getElementById('display-room-id').innerText = rid;
            
            try {
                await client.join(APP_ID, rid, null, me.id);
                // Create tracks ONCE
                [local.a, local.v] = await AgoraRTC.createMicrophoneAndCameraTracks(
                    { encoderConfig: "music_standard" },
                    { encoderConfig: "360p_1" } 
                );
                
                await client.publish([local.a, local.v]);
                addVideo(me.id, local.v, true);
                isCamOn = true; btnStyle('btn-cam', true);
            } catch(e) {
                console.error(e);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÑ‡∏°‡∏Ñ‡πå"); endCall();
            }
        }

        // --- VIDEO HANDLERS ---
        client.on("user-published", async (u, type) => {
            await client.subscribe(u, type);
            remoteUsers[u.uid] = u;
            if(type==='video') { addVideo(u.uid, u.videoTrack); toggleCamUI(u.uid, false); }
            if(type==='audio') u.audioTrack.play();
            updateGrid();
        });
        client.on("user-unpublished", (u, type) => {
            if(type==='video') toggleCamUI(u.uid, true); // Don't remove, show black screen
        });
        client.on("user-left", u => {
            delete remoteUsers[u.uid]; removeVideo(u.uid);
        });

        // --- UI HELPERS ---
        function addVideo(uid, track, isLocal) {
            if(document.getElementById(`vid-${uid}`)) { track.play(`play-${uid}`); toggleCamUI(uid, false); return; }
            
            const div = document.createElement('div');
            div.className = 'vid-box'; div.id = `vid-${uid}`;
            let uName = isLocal ? me.n : "User " + uid;
            let uPic = isLocal ? me.pic : "https://via.placeholder.com/150"; 
            
            div.innerHTML = `
                <div id="play-${uid}" class="vid-player"></div>
                <div id="off-${uid}" class="cam-off-ui">
                    <img src="${uPic}" class="off-avatar">
                    <div class="off-name">${uName}</div>
                    <div class="off-status">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>
                </div>
            `;
            document.getElementById('video-grid').appendChild(div);
            track.play(`play-${uid}`);
            updateGrid();
        }

        function removeVideo(uid) { const el = document.getElementById(`vid-${uid}`); if(el) el.remove(); updateGrid(); }
        function toggleCamUI(uid, isOff) {
            const el = document.getElementById(`off-${uid}`);
            if(el) isOff ? el.classList.add('active') : el.classList.remove('active');
        }
        function updateGrid() {
            const g = document.getElementById('video-grid');
            g.className = g.children.length <= 1 ? "video-grid grid-1" : "video-grid grid-2";
        }
        function endCall() {
            // Important: Don't just close, leave channel
            if(local.a) { local.a.close(); local.a = null; }
            if(local.v) { local.v.close(); local.v = null; }
            if(local.s) { local.s.close(); local.s = null; }
            client.leave();
            document.getElementById('video-grid').innerHTML='';
            go('dash');
        }

        // --- CONTROLS ---
        function toggleMic() { if(local.a) { local.a.setMuted(!local.a.muted); btnStyle('btn-mic', !local.a.muted); } }
        
        // üî• Fast Cam Toggle (No Re-Allow)
        async function toggleCam() {
            if(!local.v) return; // No track
            if(isCamOn) {
                // Turn OFF: Disable track (stops light usually) & Unpublish to show black screen on remote
                await local.v.setEnabled(false);
                await client.unpublish(local.v);
                
                toggleCamUI(me.id, true); // Local UI black
                btnStyle('btn-cam', false);
                isCamOn = false;
            } else {
                // Turn ON: Enable & Publish
                await local.v.setEnabled(true);
                await client.publish(local.v);
                
                toggleCamUI(me.id, false); // Local UI video
                btnStyle('btn-cam', true);
                isCamOn = true;
            }
        }

        // üî• Screen Share (PC/Mobile)
        async function toggleScreenShare() {
            if(isScreenOn) {
                // Stop Sharing
                await client.unpublish(local.s);
                local.s.close(); local.s = null;
                isScreenOn = false;
                btnStyle('btn-screen', false);
                
                // Return to Cam if it was on
                if(local.v) {
                    await client.publish(local.v);
                    addVideo(me.id, local.v, true);
                    toggleCamUI(me.id, !isCamOn);
                }
            } else {
                // Start Sharing
                try {
                    // Create Screen Track
                    local.s = await AgoraRTC.createScreenVideoTrack();
                    
                    // Unpublish Cam first (Agora usually allows 1 video stream per user in basic mode)
                    if(local.v) await client.unpublish(local.v);
                    
                    // Publish Screen
                    await client.publish(local.s);
                    
                    // Update Local View
                    removeVideo(me.id); // Remove cam view
                    addVideo(me.id, local.s, true); // Add screen view
                    // Hack: Mark screen as 'Me' in UI
                    const vidDiv = document.getElementById(`play-${me.id}`);
                    if(vidDiv) vidDiv.classList.add('screen-share');

                    isScreenOn = true;
                    btnStyle('btn-screen', true);

                    // Listen for browser "Stop Sharing" button
                    local.s.on("track-ended", () => {
                        toggleScreenShare(); // recursive call to handle stop logic
                    });

                } catch(e) {
                    console.error(e);
                    // User cancelled or not supported
                }
            }
        }

        function toggleSpeaker() { /* Speaker logic */ }
        function btnStyle(id, on) {
            const el = document.getElementById(id);
            if(on) { el.classList.add('active'); el.classList.remove('off'); }
            else { el.classList.add('off'); el.classList.remove('active'); }
        }
    </script>
</body>
</html>