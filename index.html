<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChatApp v2.2 - Final Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg: #f3f4f6;
            --glass: rgba(255, 255, 255, 0.95);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; display: flex; color: #333; }

        /* Login Screen */
        #login-screen {
            position: fixed; inset: 0; background: var(--primary); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 400px;
        }
        .google-btn {
            background: #4285F4; color: white; padding: 12px 20px; border: none; border-radius: 5px;
            font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; margin-top: 20px; transition: 0.2s;
        }
        .google-btn:hover { background: #357ae8; }
        .error-box {
            background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px; margin-top: 15px;
            font-size: 14px; display: none; text-align: left; border: 1px solid #ef9a9a;
        }

        /* App Layout */
        #app-container { display: none; width: 100%; height: 100%; max-width: 1200px; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .sidebar { width: 320px; background: #f8f9fa; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; background: #fff; }

        /* Components */
        .my-profile { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: white; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #ddd; }
        
        .search-box { padding: 10px; display: flex; gap: 5px; }
        .search-box input { flex: 1; padding: 8px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        .add-btn { background: #667eea; color: white; border: none; width: 35px; border-radius: 50%; cursor: pointer; }

        .friend-list { flex: 1; overflow-y: auto; }
        .friend-item { padding: 10px 15px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .friend-item:hover { background: #eef2ff; }
        
        /* Chat UI */
        .chat-header { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #f0f2f5; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 15px; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: #667eea; color: white; border-bottom-right-radius: 2px; }
        .msg-friend { align-self: flex-start; background: white; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
        
        .input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center; background: white; }
        .input-area input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 300px; text-align: center; }
        
        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; z-index: 10; transition: 0.3s; }
            .chat-area { width: 100%; position: absolute; height: 100%; transform: translateX(100%); transition: 0.3s; z-index: 20; }
            body.view-chat .sidebar { transform: translateX(-20%); }
            body.view-chat .chat-area { transform: translateX(0); }
            .back-btn { display: inline-block !important; }
        }
        .back-btn { display: none; font-size: 20px; background: none; border: none; cursor: pointer; margin-right: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="view-list">

    <div id="login-screen">
        <div class="login-card">
            <h1 style="margin:0; color:#333;">ChatApp v2.2</h1>
            <p style="color:#666;">‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ + ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Error</p>
            
            <div id="file-error" style="background:#fff3cd; color:#856404; padding:10px; border-radius:5px; text-align:left; font-size:13px; display:none; border:1px solid #ffeeba;">
                ‚ö†Ô∏è <b>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</b> ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏ß‡∏¥‡∏ò‡∏µ (file://) <br>
                Google Login ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô! <br>
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô <b>Live Server</b> ‡πÉ‡∏ô VS Code <br>
                (http://127.0.0.1...)
            </div>

            <button class="google-btn" id="login-btn" onclick="logic.login()">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
            
            <div id="login-error" class="error-box"></div>
        </div>
    </div>

    <div id="app-container">
        <div class="sidebar">
            <div class="my-profile">
                <img id="my-avatar" class="avatar" src="">
                <div style="flex:1;">
                    <b id="my-name">Loading...</b><br>
                    <small style="color:green">‚óè ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</small>
                </div>
                <button onclick="ui.openProfile()" style="border:none; background:none; cursor:pointer;">‚öôÔ∏è</button>
                <button onclick="logic.logout()" style="color:red; border:none; background:none; cursor:pointer;">‡∏≠‡∏≠‡∏Å</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="add-input" placeholder="‡πÑ‡∏≠‡∏î‡∏µ/‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...">
                <button class="add-btn" onclick="logic.addFriend()">+</button>
            </div>
            <div id="search-msg" style="font-size:12px; padding:0 10px; color:red;"></div>

            <div style="padding:10px; display:flex; justify-content:space-between;">
                <small>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</small>
                <button onclick="ui.toggleReq()" style="border:none; background:none; cursor:pointer;">
                    üîî <span id="badge" class="hidden" style="background:red; color:white; padding:2px 5px; border-radius:10px; font-size:10px;">0</span>
                </button>
            </div>

            <div id="friend-list" class="friend-list"></div>
        </div>

        <div class="chat-area">
            <div id="empty-view" style="height:100%; display:flex; justify-content:center; align-items:center; color:#888;">
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢
            </div>

            <div id="chat-view" class="hidden" style="display:flex; flex-direction:column; height:100%;">
                <div class="chat-header">
                    <div style="display:flex; align-items:center;">
                        <button class="back-btn" onclick="ui.goBack()">‚ùÆ</button>
                        <img id="head-img" class="avatar" style="margin-right:10px;">
                        <b id="head-name">User</b>
                    </div>
                </div>
                
                <div id="messages" class="messages"></div>
                
                <div class="input-area">
                    <input type="text" id="msg-in" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeyup="if(event.key==='Enter') logic.send()">
                    <button onclick="logic.send()" style="background:#667eea; color:white; border:none; padding:10px 15px; border-radius:20px; cursor:pointer;">‡∏™‡πà‡∏á</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
            <img id="edit-img-preview" src="" style="width:60px; height:60px; border-radius:50%; margin:10px;">
            <br>
            <input type="file" id="file-up" accept="image/*" onchange="logic.previewFile(this)">
            <input type="text" id="edit-name-in" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:5px;">
            <button onclick="logic.saveProfile()" style="width:100%; padding:10px; background:green; color:white; border:none; border-radius:5px; cursor:pointer;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="document.getElementById('profile-modal').style.display='none'" style="margin-top:10px; border:none; background:none; cursor:pointer; color:red;">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="req-modal" class="modal">
        <div class="modal-content">
            <h3>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
            <div id="req-list" style="text-align:left;"></div>
            <button onclick="document.getElementById('req-modal').style.display='none'" style="margin-top:20px; border:none; background:none; cursor:pointer;">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏ß‡∏¥‡∏ò‡∏µ ---
        if (window.location.protocol === 'file:') {
            document.getElementById('file-error').style.display = 'block';
            document.getElementById('login-btn').style.opacity = '0.5';
        }

        // ===========================================
        // ‚ö†Ô∏è‚ö†Ô∏è ‡πÉ‡∏™‡πà API KEY ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö) ‚ö†Ô∏è‚ö†Ô∏è
        // ===========================================
        const firebaseConfig = {
  apiKey: "AIzaSyB575txzpvEoiUPGAzMWmBIJ-AumUrPZ04",
  authDomain: "mychatapp-6553a.firebaseapp.com",
  databaseURL: "https://mychatapp-6553a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mychatapp-6553a",
  storageBucket: "mychatapp-6553a.firebasestorage.app",
  messagingSenderId: "327022378740",
  appId: "1:327022378740:web:325ea6d58ed16d5190e8a1",
  measurementId: "G-G7ECFJ2R3W"
};
        // ===========================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentChatId = null;
        let unsubMessages = null;
        let tempAvatar = null;

        window.ui = {
            toggleReq: () => document.getElementById('req-modal').style.display = 'flex',
            openProfile: () => {
                document.getElementById('profile-modal').style.display = 'flex';
                document.getElementById('edit-name-in').value = currentUser.name;
                document.getElementById('edit-img-preview').src = currentUser.avatar;
            },
            goChat: () => {
                document.body.classList.add('view-chat');
                document.getElementById('empty-view').classList.add('hidden');
                document.getElementById('chat-view').classList.remove('hidden');
            },
            goBack: () => {
                document.body.classList.remove('view-chat');
                currentChatId = null;
            }
        };

        window.logic = {
            login: async () => {
                const errBox = document.getElementById('login-error');
                errBox.style.display = 'none';
                
                if (window.location.protocol === 'file:') {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏ß‡∏¥‡∏ò‡∏µ (file://)\n‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Server ‡∏´‡∏£‡∏∑‡∏≠ localhost ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    return;
                }

                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                } catch (e) {
                    console.error(e);
                    errBox.style.display = 'block';
                    errBox.innerHTML = `<b>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</b><br>${e.code}<br>${e.message}`;
                    if(e.code === 'auth/operation-not-allowed') {
                        errBox.innerHTML += "<br><br><b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</b> ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Google Sign-In ‡πÉ‡∏ô Firebase Console > Authentication";
                    }
                    if(e.code === 'auth/unauthorized-domain') {
                        errBox.innerHTML += "<br><br><b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</b> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡πÄ‡∏°‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 127.0.0.1) ‡πÉ‡∏ô Firebase > Authentication > Settings > Authorized domains";
                    }
                }
            },
            logout: () => signOut(auth),

            initUser: async (u) => {
                const ref = doc(db, "users", u.uid);
                
                // Realtime Listener
                onSnapshot(ref, async (snap) => {
                    if (!snap.exists()) {
                        // Create User if not exists
                        await setDoc(ref, {
                            name: u.displayName,
                            email: u.email,
                            avatar: u.photoURL,
                            searchName: u.displayName.toLowerCase(),
                            friends: [],
                            requests: []
                        });
                    } else {
                        currentUser = { uid: u.uid, ...snap.data() };
                        document.getElementById('my-name').textContent = currentUser.name;
                        document.getElementById('my-avatar').src = currentUser.avatar;
                        renderFriends(currentUser.friends);
                        renderReqs(currentUser.requests);
                    }
                });
            },

            addFriend: async () => {
                const txt = document.getElementById('add-input').value.trim().toLowerCase();
                const msg = document.getElementById('search-msg');
                msg.textContent = "";

                if(!txt) return;
                if(txt === currentUser.searchName) return alert("‡πÅ‡∏≠‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");

                const q = query(collection(db, "users"), where("searchName", "==", txt));
                const snap = await getDocs(q);

                if(snap.empty) {
                    msg.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ";
                } else {
                    const target = snap.docs[0];
                    if(currentUser.friends.some(f => f.uid === target.id)) return alert("‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
                    
                    await updateDoc(doc(db, "users", target.id), {
                        requests: arrayUnion({ uid: currentUser.uid, name: currentUser.name, avatar: currentUser.avatar })
                    });
                    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß!");
                    document.getElementById('add-input').value = "";
                }
            },

            acceptReq: async (r) => {
                // Create Chat Room
                const chatRef = await addDoc(collection(db, "chats"), {
                    users: [currentUser.uid, r.uid],
                    createdAt: serverTimestamp()
                });

                // Add Friend (Me)
                await updateDoc(doc(db, "users", currentUser.uid), {
                    friends: arrayUnion({ uid: r.uid, name: r.name, avatar: r.avatar, chatId: chatRef.id }),
                    requests: arrayRemove(r)
                });

                // Add Friend (Them)
                await updateDoc(doc(db, "users", r.uid), {
                    friends: arrayUnion({ uid: currentUser.uid, name: currentUser.name, avatar: currentUser.avatar, chatId: chatRef.id })
                });

                document.getElementById('req-modal').style.display='none';
            },

            openChat: (f) => {
                currentChatId = f.chatId;
                document.getElementById('head-name').textContent = f.name;
                document.getElementById('head-img').src = f.avatar;
                ui.goChat();

                if(unsubMessages) unsubMessages();
                const q = query(collection(db, "chats", currentChatId, "messages")); // Simple Query
                
                unsubMessages = onSnapshot(q, (snap) => {
                    const msgs = [];
                    snap.forEach(d => msgs.push(d.data()));
                    msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    
                    const div = document.getElementById('messages');
                    div.innerHTML = "";
                    msgs.forEach(m => {
                        div.innerHTML += `
                            <div class="message ${m.sender === currentUser.uid ? 'msg-me' : 'msg-friend'}">
                                ${m.text}
                            </div>`;
                    });
                    div.scrollTop = div.scrollHeight;
                });
            },

            send: async () => {
                const txt = document.getElementById('msg-in').value.trim();
                if(!txt) return;
                await addDoc(collection(db, "chats", currentChatId, "messages"), {
                    sender: currentUser.uid,
                    text: txt,
                    timestamp: serverTimestamp()
                });
                document.getElementById('msg-in').value = "";
            },

            previewFile: (input) => {
                const file = input.files[0];
                if(file){
                    const reader = new FileReader();
                    reader.onload = (e) => {
                         // Canvas Resize
                         const img = new Image();
                         img.onload = () => {
                             const c = document.createElement('canvas');
                             const scale = 200 / img.width;
                             c.width = 200;
                             c.height = img.height * scale;
                             c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                             tempAvatar = c.toDataURL('image/jpeg', 0.7);
                             document.getElementById('edit-img-preview').src = tempAvatar;
                         };
                         img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            saveProfile: async () => {
                const newName = document.getElementById('edit-name-in').value;
                const data = { name: newName, searchName: newName.toLowerCase() };
                if(tempAvatar) data.avatar = tempAvatar;
                
                await updateDoc(doc(db, "users", currentUser.uid), data);
                document.getElementById('profile-modal').style.display='none';
            }
        };

        // Render Helpers
        function renderFriends(list) {
            const div = document.getElementById('friend-list');
            div.innerHTML = "";
            list.forEach(f => {
                const el = document.createElement('div');
                el.className = "friend-item";
                el.onclick = () => logic.openChat(f);
                el.innerHTML = `<img src="${f.avatar}" class="avatar"> ${f.name}`;
                div.appendChild(el);
            });
        }

        function renderReqs(list) {
            const div = document.getElementById('req-list');
            const badge = document.getElementById('badge');
            div.innerHTML = "";
            
            if(list.length > 0) {
                badge.textContent = list.length;
                badge.classList.remove('hidden');
                list.forEach(r => {
                    const el = document.createElement('div');
                    el.style = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;";
                    el.innerHTML = `
                        <span>${r.name}</span>
                        <button onclick='logic.acceptReq(${JSON.stringify(r)})' style="background:green; color:white; border:none; border-radius:3px; cursor:pointer;">‡∏£‡∏±‡∏ö</button>
                    `;
                    div.appendChild(el);
                });
            } else {
                badge.classList.add('hidden');
                div.innerHTML = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠";
            }
        }

        onAuthStateChanged(auth, (u) => {
            if (u) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                logic.initUser(u);
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        });
    </script>
</body>
</html>