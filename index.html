<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp v1.6 - Real Online</title>
    <style>
        /* CSS UI ‡πÄ‡∏î‡∏¥‡∏° + ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á */
        :root { --primary: #4285f4; --bg: #f0f2f5; --red: #e41e3f; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; overflow: hidden; }
        
        /* Login */
        #login-screen { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        .google-btn { background: #4285f4; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        /* Layout */
        #app-container { display: none; width: 100%; height: 100%; }
        .sidebar { width: 300px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; position: relative; }
        
        /* Components */
        .my-profile { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #ccc; }
        .search-box { margin: 10px; display: flex; gap: 5px; }
        .search-box input { flex: 1; padding: 8px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        .nav-btn { background: none; border: none; font-size: 20px; cursor: pointer; position: relative; }
        .red-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: var(--red); border-radius: 50%; display: none; }
        
        .friend-list { flex: 1; overflow-y: auto; }
        .friend-item { padding: 10px 15px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .friend-item:hover { background: #f0f2f5; }
        .friend-item.active { background: #e7f3ff; }
        
        /* Chat */
        .chat-header { padding: 10px; background: white; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 65%; padding: 8px 12px; border-radius: 15px; font-size: 14px; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: #d9fdd3; }
        .msg-friend { align-self: flex-start; background: white; }
        .msg-img { max-width: 200px; border-radius: 10px; margin-top: 5px; display: block; }
        
        .input-area { padding: 10px; background: white; display: flex; gap: 10px; align-items: center; }
        .input-area input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        .send-btn { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 50%; cursor: pointer; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 200; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 320px; }
        .req-item { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }

        /* Call Screen */
        #call-screen { display: none; position: fixed; inset: 0; background: #222; color: white; flex-direction: column; justify-content: center; align-items: center; z-index: 300; }
        .call-avatar { width: 120px; height: 120px; border-radius: 50%; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }
        .call-controls { display: flex; gap: 20px; margin-top: 30px; }
        .c-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .btn-end { background: #ff4b4b; color: white; }
        .btn-accept { background: #00b341; color: white; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>ChatApp v1.6</h1>
        <p>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö Real-time</p>
        <button class="google-btn" id="login-btn">
            Login with Google
        </button>
    </div>

    <div id="app-container">
        <div class="sidebar">
            <div class="my-profile">
                <img id="my-avatar" class="avatar" src="">
                <div style="flex:1;">
                    <div id="my-name" style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:150px;">User</div>
                    <small style="color:green;">‚óè Online</small>
                </div>
                <button onclick="ui.openProfile()" style="font-size:12px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button id="logout-btn" style="color:red; font-size:12px;">‡∏≠‡∏≠‡∏Å</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="friend-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô...">
                <button class="nav-btn" id="add-friend-btn">‚ûï</button>
                <button class="nav-btn" onclick="ui.toggleRequests()">
                    üîî<div id="red-dot" class="red-dot"></div>
                </button>
            </div>

            <div id="friend-list" class="friend-list"></div>
        </div>

        <div class="chat-area">
            <div id="no-chat-bg" style="position:absolute; inset:0; display:flex; justify-content:center; align-items:center; color:#888;">
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢
            </div>

            <div id="active-chat" class="hidden" style="display:flex; flex-direction:column; height:100%;">
                <div class="chat-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img id="chat-img" class="avatar" src="">
                        <h3 id="chat-name" style="margin:0;">Friend</h3>
                    </div>
                    <div>
                        <button class="nav-btn" id="call-btn">üìû</button>
                        <button class="nav-btn" onclick="logic.blockFriend()" style="color:orange;">üö´</button>
                        <button class="nav-btn" onclick="logic.deleteFriend()" style="color:red;">üóëÔ∏è</button>
                    </div>
                </div>

                <div id="messages" class="messages"></div>

                <div id="input-bar" class="input-area">
                    <label for="img-up" style="cursor:pointer; font-size:20px;">üì∑</label>
                    <input type="file" id="img-up" accept="image/*" hidden>
                    <input type="text" id="msg-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
                    <button id="send-btn" class="send-btn">‚û§</button>
                </div>
                
                <div id="blocked-alert" class="hidden" style="padding:20px; text-align:center; background:#eee; color:red;">
                    ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ (‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏Ç‡∏≤‡∏≠‡∏¢‡∏π‡πà)
                </div>
            </div>
        </div>
    </div>

    <div id="req-modal" class="modal">
        <div class="modal-content">
            <h3>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô <span onclick="document.getElementById('req-modal').style.display='none'" style="float:right; cursor:pointer;">‚úñ</span></h3>
            <div id="req-list"></div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
            <input type="text" id="edit-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà" style="width:90%; padding:5px; margin-bottom:10px;">
            <input type="text" id="edit-pic" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" style="width:90%; padding:5px; margin-bottom:10px;">
            <div id="edit-err" style="color:red; font-size:12px; margin-bottom:10px;"></div>
            <button onclick="logic.saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>

    <div id="call-screen">
        <img id="call-avatar" class="call-avatar" src="">
        <h2 id="call-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏£...</h2>
        <div id="call-controls" class="call-controls">
            </div>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <script type="module">
        // -----------------------------------------------------
        // 1. ‡∏ô‡∏≥ FIREBASE CONFIG ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ !!!
        // -----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, setDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- ‡∏ß‡∏≤‡∏á Config ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Firebase Console ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyB575txzpvEoiUPGAzMWmBIJ-AumUrPZ04",
  authDomain: "mychatapp-6553a.firebaseapp.com",
  databaseURL: "https://mychatapp-6553a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mychatapp-6553a",
  storageBucket: "mychatapp-6553a.firebasestorage.app",
  messagingSenderId: "327022378740",
  appId: "1:327022378740:web:325ea6d58ed16d5190e8a1",
  measurementId: "G-G7ECFJ2R3W"
};
        // -----------------------------------------------------

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentChatId = null;
        let currentFriendId = null;
        let unsubscribeChat = null;
        let peerConnection = null;
        let localStream = null;
        
        // --- UI Helper ---
        window.ui = {
            toggleRequests: () => document.getElementById('req-modal').style.display = 'flex',
            openProfile: () => {
                document.getElementById('profile-modal').style.display = 'flex';
                document.getElementById('edit-name').value = currentUser.name || '';
                document.getElementById('edit-pic').value = currentUser.avatar || '';
            },
            closeModal: () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'),
            showCall: (name, avatar, isIncoming) => {
                document.getElementById('call-screen').style.display = 'flex';
                document.getElementById('call-avatar').src = avatar;
                document.getElementById('call-status').textContent = isIncoming ? name + " ‡πÇ‡∏ó‡∏£‡∏°‡∏≤..." : "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏£‡∏´‡∏≤ " + name;
                
                const controls = document.getElementById('call-controls');
                controls.innerHTML = '';
                
                const endBtn = `<button class="c-btn btn-end" onclick="logic.endCall()">‚òé</button>`;
                
                if (isIncoming) {
                    controls.innerHTML = `<button class="c-btn btn-accept" onclick="logic.answerCall()">üìû</button>` + endBtn;
                } else {
                    controls.innerHTML = endBtn;
                }
            }
        };

        // --- Main Logic ---
        window.logic = {
            // 1. Auth & User Setup
            login: async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (e) { alert("Login Error: " + e.message); }
            },
            logout: () => signOut(auth),

            initUser: async (user) => {
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                
                if (!snap.exists()) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÉ‡∏´‡∏°‡πà
                    await setDoc(userRef, {
                        name: user.displayName,
                        email: user.email,
                        avatar: user.photoURL,
                        searchName: user.displayName.toLowerCase(), // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢
                        lastRename: 0,
                        blocked: []
                    });
                }
                
                // Realtime Listener ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Requests)
                onSnapshot(userRef, (doc) => {
                    currentUser = { uid: user.uid, ...doc.data() };
                    document.getElementById('my-name').textContent = currentUser.name;
                    document.getElementById('my-avatar').src = currentUser.avatar;
                    renderRequests(currentUser.requests || []);
                    renderFriends(currentUser.friends || []);
                    checkForIncomingCall(currentUser.incomingCall);
                });
            },

            // 2. Friend System
            addFriend: async () => {
                const name = document.getElementById('friend-search').value.trim().toLowerCase();
                if (!name) return;
                
                if (name === currentUser.name.toLowerCase()) return alert("‡πÅ‡∏≠‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö");

                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ
                const q = query(collection(db, "users"), where("searchName", "==", name));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ");
                } else {
                    const targetUser = snapshot.docs[0];
                    const targetData = targetUser.data();
                    
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡∏±‡∏á
                    if (currentUser.friends && currentUser.friends.find(f => f.uid === targetUser.id)) {
                        return alert("‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
                    }

                    // ‡∏™‡πà‡∏á Request (Update Array ‡πÉ‡∏ô Target DB)
                    const reqObj = { uid: currentUser.uid, name: currentUser.name, avatar: currentUser.avatar };
                    
                    // ‡πÉ‡∏ä‡πâ arrayUnion ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° request ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                    await updateDoc(doc(db, "users", targetUser.id), {
                        requests: arrayUnion(reqObj)
                    });
                    
                    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß!");
                    document.getElementById('friend-search').value = '';
                }
            },

            acceptFriend: async (reqUid, reqName, reqAvatar) => {
                // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Chat Room ‡πÉ‡∏´‡∏°‡πà
                const chatRef = await addDoc(collection(db, "chats"), {
                    users: [currentUser.uid, reqUid],
                    createdAt: serverTimestamp()
                });

                // 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤
                const myFriendData = { uid: reqUid, name: reqName, avatar: reqAvatar, chatId: chatRef.id };
                await updateDoc(doc(db, "users", currentUser.uid), {
                    friends: arrayUnion(myFriendData),
                    requests: arrayRemove({ uid: reqUid, name: reqName, avatar: reqAvatar }) // ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å
                });

                // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï doc ‡πÄ‡∏Ç‡∏≤‡∏î‡πâ‡∏ß‡∏¢)
                const hisFriendData = { uid: currentUser.uid, name: currentUser.name, avatar: currentUser.avatar, chatId: chatRef.id };
                await updateDoc(doc(db, "users", reqUid), {
                    friends: arrayUnion(hisFriendData)
                });
            },
            
            rejectRequest: async (reqObj) => {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    requests: arrayRemove(reqObj)
                });
            },

            // 3. Chat System
            openChat: (friendUid, chatId, name, avatar) => {
                currentFriendId = friendUid;
                currentChatId = chatId;
                
                // UI
                document.getElementById('no-chat-bg').classList.add('hidden');
                document.getElementById('active-chat').classList.remove('hidden');
                document.getElementById('chat-name').textContent = name;
                document.getElementById('chat-img').src = avatar;
                
                // Check Block
                const isBlocked = currentUser.blocked?.includes(friendUid);
                const inputBar = document.getElementById('input-bar');
                const blockAlert = document.getElementById('blocked-alert');
                
                if (isBlocked) {
                    inputBar.style.display = 'none';
                    blockAlert.classList.remove('hidden');
                    blockAlert.textContent = "‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà";
                } else {
                    inputBar.style.display = 'flex';
                    blockAlert.classList.add('hidden');
                }

                // Load Messages Realtime
                if (unsubscribeChat) unsubscribeChat(); // ‡πÄ‡∏•‡∏¥‡∏Å‡∏ü‡∏±‡∏á‡πÅ‡∏ä‡∏ó‡πÄ‡∏Å‡πà‡∏≤
                
                const q = query(collection(db, "chats", chatId, "messages"), window.orderByFunc("timestamp", "asc"));
                // *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ index ‡πÉ‡∏ô firestore ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ orderBy. ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î dev ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏ü‡πâ‡∏≠‡∏á link ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á index
                // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ ‡∏ú‡∏°‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏°‡∏≤ sort client-side ‡∏´‡∏£‡∏∑‡∏≠ ‡πÉ‡∏ä‡πâ timestamp ‡∏á‡πà‡∏≤‡∏¢‡πÜ
                
                // Hack: ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å orderBy ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡∏ú‡∏°‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß sort JS ‡πÅ‡∏ó‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÇ‡∏î‡∏¢ user ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á config index
                unsubscribeChat = onSnapshot(collection(db, "chats", chatId, "messages"), (snap) => {
                    const msgs = [];
                    snap.forEach(d => msgs.push(d.data()));
                    msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    renderMessages(msgs);
                });
            },

            sendMessage: async () => {
                const txt = document.getElementById('msg-input').value.trim();
                if (!txt) return;

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡∏≤‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏≤‡πÑ‡∏´‡∏° (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡πà Security Rules ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô profile ‡πÄ‡∏Ç‡∏≤)
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                
                await addDoc(collection(db, "chats", currentChatId, "messages"), {
                    sender: currentUser.uid,
                    text: txt,
                    type: 'text',
                    timestamp: serverTimestamp()
                });
                document.getElementById('msg-input').value = '';
            },

            sendImage: async (file) => {
                // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64 (‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà)
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result;
                    // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: Firestore ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ 1MB
                    if (base64.length > 900000) return alert("‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ");
                    
                    await addDoc(collection(db, "chats", currentChatId, "messages"), {
                        sender: currentUser.uid,
                        image: base64,
                        type: 'image',
                        timestamp: serverTimestamp()
                    });
                };
                reader.readAsDataURL(file);
            },
            
            // 4. Block & Delete
            blockFriend: async () => {
                if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å/‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Å?")) return;
                
                const isBlocked = currentUser.blocked?.includes(currentFriendId);
                if (isBlocked) {
                    await updateDoc(doc(db, "users", currentUser.uid), { blocked: arrayRemove(currentFriendId) });
                } else {
                    await updateDoc(doc(db, "users", currentUser.uid), { blocked: arrayUnion(currentFriendId) });
                }
                // Refresh UI ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å onSnapshot ‡πÄ‡∏≠‡∏á
                alert("‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            },

            deleteFriend: async () => {
                if(!confirm("‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?")) return;
                
                // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å array friends ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ (‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡πá‡∏´‡∏≤‡∏¢)
                // ‡∏´‡∏≤ object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô array
                const friendObj = currentUser.friends.find(f => f.uid === currentFriendId);
                
                await updateDoc(doc(db, "users", currentUser.uid), {
                    friends: arrayRemove(friendObj)
                });
                
                document.getElementById('active-chat').classList.add('hidden');
                document.getElementById('no-chat-bg').classList.remove('hidden');
            },

            // 5. Profile
            saveProfile: async () => {
                const newName = document.getElementById('edit-name').value;
                const newAvatar = document.getElementById('edit-pic').value;
                
                const now = Date.now();
                // 7 days = 604800000 ms
                if (currentUser.lastRename && (now - currentUser.lastRename < 604800000)) {
                    document.getElementById('edit-err').textContent = "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô";
                    return;
                }
                
                await updateDoc(doc(db, "users", currentUser.uid), {
                    name: newName,
                    searchName: newName.toLowerCase(),
                    avatar: newAvatar,
                    lastRename: now
                });
                
                ui.closeModal();
            },
            
            // 6. Call System (Simplified Signaling via Firestore)
            callFriend: async () => {
                if (!navigator.onLine) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡πá‡∏ï");
                
                // ‡∏™‡πà‡∏á Signal ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Doc ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                await updateDoc(doc(db, "users", currentFriendId), {
                    incomingCall: {
                        fromUid: currentUser.uid,
                        fromName: currentUser.name,
                        fromAvatar: currentUser.avatar,
                        signal: "offer" // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏á‡πà‡∏≤‡∏¢‡πÜ
                    }
                });
                
                ui.showCall(document.getElementById('chat-name').textContent, document.getElementById('chat-img').src, false);
            },
            
            answerCall: async () => {
                // ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î WebRTC PeerConnection
                // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏ú‡∏°‡∏à‡∏∞‡∏à‡∏≥‡∏•‡∏≠‡∏á state ‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏£‡∏¥‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ STUN Server
                
                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå incomingCall
                await updateDoc(doc(db, "users", currentUser.uid), { incomingCall: null });
                document.getElementById('call-status').textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß (Demo Voice)";
                
                // Note: ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ WebRTC ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠‡∏ö‡∏±‡πä‡∏Å‡∏°‡∏≤‡∏Å 
                // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ UI ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
            },
            
            endCall: async () => {
                document.getElementById('call-screen').style.display = 'none';
                if (currentFriendId) {
                    // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ)
                    // ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏õ‡∏¥‡∏î UI ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
                }
            }
        };

        // --- Render Functions ---
        function renderRequests(reqs) {
            const list = document.getElementById('req-list');
            const dot = document.getElementById('red-dot');
            list.innerHTML = '';
            
            if (reqs.length > 0) {
                dot.style.display = 'block';
                reqs.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'req-item';
                    div.innerHTML = `
                        <span><img src="${r.avatar}" style="width:30px; border-radius:50%"> ${r.name}</span>
                        <div>
                            <button onclick='window.logic.acceptFriend("${r.uid}", "${r.name}", "${r.avatar}")' style="color:green;">‡∏£‡∏±‡∏ö</button>
                            <button onclick='window.logic.rejectRequest(${JSON.stringify(r)})' style="color:red;">‡∏ó‡∏¥‡πâ‡∏á</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } else {
                dot.style.display = 'none';
                list.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</p>';
            }
        }

        function renderFriends(friends) {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            friends.forEach(f => {
                const div = document.createElement('div');
                div.className = `friend-item ${currentChatId === f.chatId ? 'active' : ''}`;
                div.onclick = () => window.logic.openChat(f.uid, f.chatId, f.name, f.avatar);
                div.innerHTML = `
                    <img src="${f.avatar}" class="avatar">
                    <div><b>${f.name}</b></div>
                `;
                list.appendChild(div);
            });
        }

        function renderMessages(msgs) {
            const cont = document.getElementById('messages');
            cont.innerHTML = '';
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `message ${m.sender === currentUser.uid ? 'msg-me' : 'msg-friend'}`;
                if (m.type === 'text') div.textContent = m.text;
                if (m.type === 'image') div.innerHTML = `<img src="${m.image}" class="msg-img">`;
                cont.appendChild(div);
            });
            cont.scrollTop = cont.scrollHeight;
        }
        
        function checkForIncomingCall(callData) {
            if (callData && callData.signal === 'offer') {
                ui.showCall(callData.fromName, callData.fromAvatar, true);
                window.currentCallFrom = callData.fromUid;
            }
        }

        // --- Event Listeners ---
        document.getElementById('login-btn').onclick = logic.login;
        document.getElementById('logout-btn').onclick = logic.logout;
        document.getElementById('add-friend-btn').onclick = logic.addFriend;
        document.getElementById('send-btn').onclick = logic.sendMessage;
        document.getElementById('img-up').onchange = (e) => logic.sendImage(e.target.files[0]);
        document.getElementById('call-btn').onclick = logic.callFriend;

        // Auth State Check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                logic.initUser(user);
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });
        
        // Expose helpers globally for HTML onclick
        window.logic = logic;
        window.ui = ui;

    </script>
</body>
</html>