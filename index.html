<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RealTalk v1.5 - Public Video Call</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #0f172a; color: white; overflow: hidden; }
        
        /* Glassmorphism UI */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Video Grid Layout */
        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            width: 100%;
            height: 100%;
            padding: 10px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            min-height: 200px;
        }

        .video-player { width: 100%; height: 100%; object-fit: cover; }
        
        /* Mobile Optimization */
        @media (max-width: 768px) {
            #video-grid { grid-template-columns: 1fr; } 
            .mobile-full { height: 100vh; width: 100vw; }
        }

        /* Hide Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
    </style>
</head>
<body class="h-screen w-screen relative">

    <div id="auth-screen" class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900 bg-[url('https://source.unsplash.com/random/1920x1080?technology')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/60"></div>
        
        <div id="login-form" class="glass p-8 rounded-2xl shadow-2xl w-96 relative z-10 animate-fade-in-up">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">เข้าสู่ระบบ</h1>
            <input type="text" id="login-name" placeholder="ชื่อผู้ใช้" class="w-full p-3 mb-4 bg-slate-800 rounded-lg border border-slate-600 focus:outline-none focus:border-blue-500">
            <input type="tel" id="login-phone" placeholder="เบอร์โทรศัพท์" class="w-full p-3 mb-6 bg-slate-800 rounded-lg border border-slate-600 focus:outline-none focus:border-blue-500">
            <button onclick="handleLogin()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold transition">ตกลง</button>
            <p class="mt-4 text-center text-sm text-gray-400">ยังไม่มีบัญชี? <span onclick="toggleAuth('signup')" class="text-blue-400 cursor-pointer hover:underline">สร้างชื่อผู้ใช้</span></p>
        </div>

        <div id="signup-form" class="hidden glass p-8 rounded-2xl shadow-2xl w-96 relative z-10">
            <h1 class="text-2xl font-bold text-center mb-6 text-green-400">สร้างผู้ใช้ใหม่</h1>
            <div class="flex justify-center mb-4">
                <div class="relative w-20 h-20 rounded-full bg-slate-700 overflow-hidden border-2 border-green-400">
                    <img id="signup-preview" src="https://via.placeholder.com/150" class="w-full h-full object-cover">
                    <input type="file" id="signup-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="previewImage(event)">
                </div>
            </div>
            <input type="text" id="signup-name" placeholder="ตั้งชื่อผู้ใช้ (ห้ามซ้ำ)" class="w-full p-3 mb-4 bg-slate-800 rounded-lg border border-slate-600">
            <input type="tel" id="signup-phone" placeholder="เบอร์โทรศัพท์" class="w-full p-3 mb-6 bg-slate-800 rounded-lg border border-slate-600">
            <button onclick="handleSignup()" class="w-full py-3 bg-green-600 hover:bg-green-500 rounded-lg font-bold transition">บันทึกข้อมูล</button>
            <button onclick="toggleAuth('login')" class="w-full mt-2 py-2 text-gray-400 hover:text-white transition">ยกเลิก</button>
        </div>
    </div>

    <div id="dashboard" class="hidden absolute inset-0 bg-slate-900 overflow-hidden">
        
        <div class="md:hidden h-full flex flex-col p-4 relative z-10 overflow-y-auto">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 rounded-full overflow-hidden border-2 border-blue-500 relative group">
                        <img id="user-avatar-mobile" src="" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center cursor-pointer" onclick="editProfile()">
                            <i class="fas fa-camera text-white"></i>
                        </div>
                    </div>
                    <div>
                        <h2 id="user-name-display-mobile" class="text-xl font-bold">User</h2>
                        <p id="user-phone-display-mobile" class="text-xs text-gray-400">08X-XXX-XXXX</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleMobileSearch(true)" class="text-blue-400 hover:bg-blue-500/20 p-2 rounded-lg">
                        <i class="fas fa-search text-xl"></i>
                    </button>
                    <button onclick="logout()" class="text-red-400 hover:bg-red-500/20 p-2 rounded-lg">
                        <i class="fas fa-power-off text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-sm uppercase text-gray-400 font-bold mb-3">สร้างห้องโทร</h3>
                <button onclick="createRoom()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl font-bold shadow-lg hover:shadow-blue-500/50 transition flex items-center justify-center gap-2">
                    <i class="fas fa-video"></i> สร้างห้องใหม่
                </button>
            </div>

            <div class="flex-1 overflow-y-auto pb-20">
                <h3 class="text-sm uppercase text-gray-400 font-bold mb-3">ห้องของคุณ</h3>
                <div id="room-list-mobile" class="space-y-2">
                    </div>
            </div>
        </div>

        <div id="mobile-search-overlay" class="md:hidden hidden absolute inset-0 z-20 bg-slate-900/95 flex items-start justify-center pt-20 p-4 transition-all duration-300">
             <div class="glass p-6 rounded-2xl text-center w-full max-w-md relative animate-fade-in-up">
                <button onclick="toggleMobileSearch(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h2 class="text-2xl font-bold mb-6">เข้าร่วมการสนทนา</h2>
                <div class="flex gap-2">
                    <input type="text" id="join-room-id-mobile" placeholder="ใส่ ID ห้อง..." class="flex-1 p-3 bg-slate-800 rounded-xl border border-slate-600 focus:border-blue-500 outline-none text-center text-lg tracking-widest">
                    <button onclick="joinRoomCheck('mobile')" class="px-6 py-3 bg-blue-600 rounded-xl font-bold hover:bg-blue-500"><i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>


        <div class="hidden md:flex h-full flex-row relative z-10">
            <div class="w-80 glass p-6 flex flex-col border-r border-slate-700 z-20">
                <div class="flex items-center space-x-4 mb-8">
                    <div class="w-14 h-14 rounded-full overflow-hidden border-2 border-blue-500 relative group">
                        <img id="user-avatar-pc" src="" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center cursor-pointer" onclick="editProfile()">
                            <i class="fas fa-camera text-white"></i>
                        </div>
                    </div>
                    <div>
                        <h2 id="user-name-display-pc" class="text-xl font-bold">User</h2>
                        <p id="user-phone-display-pc" class="text-xs text-gray-400">08X-XXX-XXXX</p>
                    </div>
                    <button onclick="logout()" class="ml-auto text-red-400 hover:bg-red-500/20 p-2 rounded-lg"><i class="fas fa-power-off"></i></button>
                </div>

                <div class="mb-6">
                    <h3 class="text-sm uppercase text-gray-400 font-bold mb-3">สร้างห้องโทร</h3>
                    <button onclick="createRoom()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl font-bold shadow-lg hover:shadow-blue-500/50 transition flex items-center justify-center gap-2">
                        <i class="fas fa-video"></i> สร้างห้องใหม่
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto">
                    <h3 class="text-sm uppercase text-gray-400 font-bold mb-3">ห้องของคุณ</h3>
                    <div id="room-list-pc" class="space-y-2">
                        </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col p-6 relative justify-center items-center">
                <div class="absolute top-0 left-0 w-full h-full bg-[url('https://source.unsplash.com/random/1920x1080?abstract')] bg-cover opacity-20 pointer-events-none"></div>
                
                <div class="relative z-10 max-w-xl w-full">
                    <div class="glass p-6 rounded-2xl text-center">
                        <h2 class="text-2xl font-bold mb-4">เข้าร่วมการสนทนา</h2>
                        <div class="flex gap-2">
                            <input type="text" id="join-room-id-pc" placeholder="ใส่ ID ห้องที่นี่..." class="flex-1 p-3 bg-slate-800 rounded-xl border border-slate-600 focus:border-blue-500 outline-none text-center text-lg tracking-widest">
                            <button onclick="joinRoomCheck('pc')" class="px-6 py-3 bg-blue-600 rounded-xl font-bold hover:bg-blue-500"><i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="call-room" class="hidden absolute inset-0 bg-black z-50 flex flex-col">
        
        <div class="absolute top-4 left-4 z-20 glass px-4 py-2 rounded-full flex items-center gap-2">
            <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
            <span id="room-id-display" class="font-mono font-bold text-sm">ID: 1234</span>
        </div>

        <div id="video-grid" class="flex-1">
            </div>

        <div class="glass absolute bottom-6 left-1/2 transform -translate-x-1/2 rounded-2xl px-6 py-4 flex items-center gap-4 shadow-2xl z-50 w-[90%] md:w-auto justify-center">
            
            <button id="btn-mic" onclick="toggleMic()" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition">
                <i class="fas fa-microphone"></i>
            </button>

            <button id="btn-sound" onclick="toggleAudioOutput()" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition text-green-400">
                <i class="fas fa-volume-up"></i>
            </button>

            <button id="btn-cam" onclick="toggleCam()" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition">
                <i class="fas fa-video"></i>
            </button>

            <button id="btn-switch" onclick="switchCamera()" class="md:hidden w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition">
                <i class="fas fa-sync-alt"></i>
            </button>

            <button id="btn-screen" onclick="shareScreen()" class="hidden md:flex w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 items-center justify-center transition">
                <i class="fas fa-desktop"></i>
            </button>

            <button onclick="leaveRoom()" class="w-14 h-12 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center transition shadow-lg shadow-red-600/30">
                <i class="fas fa-phone-slash text-xl"></i>
            </button>
        </div>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-[100]">
        ข้อความแจ้งเตือน
    </div>

    <script>
        // ================= CONFIGURATION =================
        const firebaseConfig = {
            apiKey: "PASTE_YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };
        const AGORA_APP_ID = "ebab3ce9350a43c4bf6fb4312a3dbd23"; 
        
        // ================= STATE & INIT =================
        let db;
        let currentUser = JSON.parse(localStorage.getItem('realtalk_user')) || null;
        let agoraClient;
        let localTracks = { video: null, audio: null, screen: null };
        let remoteUsers = {};
        let isMicOn = true;
        let isCamOn = true;
        let isAudioOn = true;
        let currentRoomId = null;

        try {
            if (firebaseConfig.apiKey !== "PASTE_YOUR_FIREBASE_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
            } else {
                console.warn("Using LocalStorage Mock DB");
                db = { mock: true }; 
            }
        } catch (e) { console.error("Firebase Init Error", e); }

        // ================= AUTH FUNCTIONS =================
        function init() {
            if (currentUser) {
                showDashboard();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        }

        function toggleAuth(mode) {
            if(mode === 'signup') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
            } else {
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }
        }

        function previewImage(event) {
            const reader = new FileReader();
            reader.onload = function(){ document.getElementById('signup-preview').src = reader.result; };
            reader.readAsDataURL(event.target.files[0]);
        }

        async function handleSignup() {
            const name = document.getElementById('signup-name').value;
            const phone = document.getElementById('signup-phone').value;
            const fileInput = document.getElementById('signup-file');
            
            if(!name || !phone) return showToast('กรุณากรอกข้อมูลให้ครบ');

            if(db.mock) {
                let users = JSON.parse(localStorage.getItem('rt_users')) || [];
                if(users.find(u => u.name === name)) return showToast('ชื่อนี้ถูกใช้แล้ว');
                
                let avatar = "https://via.placeholder.com/150";
                if(fileInput.files[0]) {
                     avatar = await toBase64(fileInput.files[0]);
                }

                const user = { name, phone, avatar, id: Date.now().toString() };
                users.push(user);
                localStorage.setItem('rt_users', JSON.stringify(users));
                
                showToast('ลงทะเบียนสำเร็จ');
                toggleAuth('login');
            } else {
                // Real Firebase Logic Here
            }
        }

        function handleLogin() {
            const name = document.getElementById('login-name').value;
            const phone = document.getElementById('login-phone').value;

            if(db.mock) {
                let users = JSON.parse(localStorage.getItem('rt_users')) || [];
                const user = users.find(u => u.name === name && u.phone === phone);
                if(user) {
                    currentUser = user;
                    localStorage.setItem('realtalk_user', JSON.stringify(user));
                    showDashboard();
                } else {
                    showToast('ชื่อหรือเบอร์โทรไม่ถูกต้อง');
                }
            } else {
                // Real Firebase Login
            }
        }

        function logout() {
            localStorage.removeItem('realtalk_user');
            location.reload();
        }

        // ================= DASHBOARD FUNCTIONS (Updated) =================
        function showDashboard() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Update Both Mobile & PC Displays
            ['mobile', 'pc'].forEach(type => {
                document.getElementById(`user-name-display-${type}`).innerText = currentUser.name;
                document.getElementById(`user-phone-display-${type}`).innerText = currentUser.phone;
                document.getElementById(`user-avatar-${type}`).src = currentUser.avatar || "https://via.placeholder.com/150";
            });

            loadMyRooms();
        }

        function toggleMobileSearch(show) {
            const overlay = document.getElementById('mobile-search-overlay');
            if(show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function createRoom() {
            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            let rooms = JSON.parse(localStorage.getItem('rt_rooms_' + currentUser.name)) || [];
            rooms.push({ id: roomId, createdBy: currentUser.name, timestamp: Date.now() });
            localStorage.setItem('rt_rooms_' + currentUser.name, JSON.stringify(rooms));
            
            loadMyRooms();
            showToast(`สร้างห้อง ${roomId} สำเร็จ!`);
            startCall(roomId);
        }

        function loadMyRooms() {
            const listMobile = document.getElementById('room-list-mobile');
            const listPc = document.getElementById('room-list-pc');
            listMobile.innerHTML = '';
            listPc.innerHTML = '';

            let rooms = JSON.parse(localStorage.getItem('rt_rooms_' + currentUser.name)) || [];
            
            rooms.forEach(room => {
                const el = document.createElement('div');
                el.className = 'bg-slate-800/50 p-3 rounded-lg flex justify-between items-center cursor-pointer hover:bg-slate-700 transition';
                el.innerHTML = `
                    <div onclick="startCall('${room.id}')" class="flex-1">
                        <span class="font-bold text-blue-400 text-lg">#${room.id}</span>
                        <span class="text-xs text-gray-400 block">Host: You</span>
                    </div>
                    <button onclick="shareRoom('${room.id}')" class="text-gray-400 hover:text-white"><i class="fas fa-share-alt"></i></button>
                `;
                // Clone for both lists
                listMobile.appendChild(el.cloneNode(true));
                listPc.appendChild(el);
            });
        }

        function joinRoomCheck(type) {
            const id = document.getElementById(`join-room-id-${type}`).value;
            if(id.length === 4) {
                if(type === 'mobile') toggleMobileSearch(false);
                startCall(id);
            } else {
                showToast('กรุณาใส่ ID 4 หลัก');
            }
        }

        // ================= CALL LOGIC (AGORA SDK) - คงเดิม =================
        async function startCall(roomId) {
            if (AGORA_APP_ID === "PASTE_YOUR_AGORA_APP_ID") {
                alert("กรุณาใส่ Agora App ID ในโค้ดบรรทัดที่ 290 ก่อนใช้งานจริง!");
                return;
            }

            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('call-room').classList.remove('hidden');
            document.getElementById('room-id-display').innerText = `ID: ${roomId}`;
            currentRoomId = roomId;

            // Initialize Agora
            agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
            
            // Event Listeners
            agoraClient.on("user-published", handleUserPublished);
            agoraClient.on("user-unpublished", handleUserUnpublished);

            try {
                const uid = await agoraClient.join(AGORA_APP_ID, roomId, null, currentUser.name);
                
                // Create Local Tracks (Audio + Video)
                localTracks.audio = await AgoraRTC.createMicrophoneAudioTrack();
                localTracks.video = await AgoraRTC.createCameraVideoTrack({
                    encoderConfig: "720p_1"
                });

                // Display Local Video
                const playerContainer = document.createElement('div');
                playerContainer.id = `user-container-${uid}`;
                playerContainer.className = 'video-container relative border-2 border-blue-500';
                playerContainer.innerHTML = `
                    <div id="user-${uid}" class="video-player"></div>
                    <div class="absolute bottom-2 left-2 bg-black/60 px-2 py-1 rounded text-xs font-bold">${currentUser.name} (คุณ)</div>
                `;
                document.getElementById('video-grid').appendChild(playerContainer);
                
                localTracks.video.play(`user-${uid}`);

                // Publish
                await agoraClient.publish([localTracks.audio, localTracks.video]);
                
                // Update Grid CSS
                updateGrid();

            } catch (error) {
                console.error(error);
                showToast("เกิดข้อผิดพลาดในการเข้าร่วม หรือห้องเต็ม");
                leaveRoom();
            }
        }

        async function handleUserPublished(user, mediaType) {
            await agoraClient.subscribe(user, mediaType);
            
            if (mediaType === 'video') {
                if(Object.keys(remoteUsers).length >= 5) {
                    showToast("ห้องเต็มแล้ว (สูงสุด 6 คน)");
                    return;
                }

                remoteUsers[user.uid] = user;

                const playerContainer = document.createElement('div');
                playerContainer.id = `user-container-${user.uid}`;
                playerContainer.className = 'video-container relative';
                playerContainer.innerHTML = `
                    <div id="user-${user.uid}" class="video-player"></div>
                    <div class="absolute bottom-2 left-2 bg-black/60 px-2 py-1 rounded text-xs font-bold">${user.uid}</div>
                `;
                document.getElementById('video-grid').appendChild(playerContainer);
                user.videoTrack.play(`user-${user.uid}`);
                updateGrid();
            }

            if (mediaType === 'audio') {
                user.audioTrack.play();
                if (!isAudioOn) user.audioTrack.setVolume(0);
            }
        }

        function handleUserUnpublished(user) {
            const playerContainer = document.getElementById(`user-container-${user.uid}`);
            if (playerContainer) playerContainer.remove();
            delete remoteUsers[user.uid];
            updateGrid();
        }

        async function leaveRoom() {
            if(localTracks.audio) { localTracks.audio.close(); localTracks.audio = null; }
            if(localTracks.video) { localTracks.video.close(); localTracks.video = null; }
            if(localTracks.screen) { localTracks.screen.close(); localTracks.screen = null; }
            
            if(agoraClient) await agoraClient.leave();
            
            document.getElementById('video-grid').innerHTML = '';
            document.getElementById('call-room').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            remoteUsers = {};
        }

        // ================= CONTROLS (คงเดิม) =================
        function toggleMic() {
            if(!localTracks.audio) return;
            isMicOn = !isMicOn;
            localTracks.audio.setMuted(!isMicOn);
            updateBtnStyle('btn-mic', isMicOn, 'fa-microphone', 'fa-microphone-slash');
        }

        function toggleCam() {
            if(!localTracks.video) return;
            isCamOn = !isCamOn;
            localTracks.video.setEnabled(isCamOn);
            updateBtnStyle('btn-cam', isCamOn, 'fa-video', 'fa-video-slash');
        }

        function toggleAudioOutput() {
            isAudioOn = !isAudioOn;
            const btn = document.getElementById('btn-sound');
            if(isAudioOn) {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.classList.remove('text-red-500');
                btn.classList.add('text-green-400');
                Object.values(remoteUsers).forEach(u => u.audioTrack && u.audioTrack.setVolume(100));
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                btn.classList.remove('text-green-400');
                btn.classList.add('text-red-500');
                Object.values(remoteUsers).forEach(u => u.audioTrack && u.audioTrack.setVolume(0));
            }
        }

        async function switchCamera() {
            try {
                const cameras = await AgoraRTC.getCameras();
                if(cameras.length < 2) return showToast("ไม่พบกล้องตัวอื่น");
                showToast("ฟีเจอร์สลับกล้องยังไม่สมบูรณ์ในตัวอย่างนี้");
            } catch(e) { console.error(e); }
        }

        async function shareScreen() {
            if(localTracks.screen) {
                await agoraClient.unpublish(localTracks.screen);
                localTracks.screen.close();
                localTracks.screen = null;
                await agoraClient.publish(localTracks.video);
                document.getElementById('btn-screen').classList.remove('bg-blue-600');
            } else {
                try {
                    localTracks.screen = await AgoraRTC.createScreenVideoTrack();
                    await agoraClient.unpublish(localTracks.video);
                    await agoraClient.publish(localTracks.screen);
                    document.getElementById('btn-screen').classList.add('bg-blue-600');
                } catch(e) { showToast("ยกเลิกแชร์หน้าจอ"); }
            }
        }

        // ================= UTILS (คงเดิม) =================
        function updateBtnStyle(id, isOn, iconOn, iconOff) {
            const btn = document.getElementById(id);
            if(isOn) {
                btn.innerHTML = `<i class="fas ${iconOn}"></i>`;
                btn.classList.remove('bg-red-500');
                btn.classList.add('bg-slate-700');
            } else {
                btn.innerHTML = `<i class="fas ${iconOff}"></i>`;
                btn.classList.remove('bg-slate-700');
                btn.classList.add('bg-red-500');
            }
        }

        function updateGrid() {
            const count = document.getElementById('video-grid').children.length;
            const grid = document.getElementById('video-grid');
            if(count === 1) grid.className = "flex items-center justify-center p-4";
            else grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 p-2 w-full h-full";
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-x-full');
            setTimeout(() => t.classList.add('translate-x-full'), 3000);
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Start App
        init();

    </script>
</body>
</html>