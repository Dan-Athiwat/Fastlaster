<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FutureCall - Realtime Video Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* Custom UI Styling */
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: white;
            font-family: 'Kanit', sans-serif;
            overflow-x: hidden;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            width: 100%;
            height: calc(100vh - 100px);
        }
        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            z-index: 10;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center justify-center p-4 relative">

    <div v-if="!appIdConfigured" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-90 z-50 flex items-center justify-center text-center p-6">
        <div class="glass-panel p-8 max-w-md">
            <h1 class="text-3xl font-bold text-red-500 mb-4">⚠️ ตั้งค่า Key ก่อน</h1>
            <p class="mb-4 text-gray-300">กรุณาแก้ไขไฟล์โค้ดแล้วใส่ <b>Agora App ID</b> ในบรรทัดที่กำหนด เพื่อให้ระบบโทรทำงานได้จริง</p>
            <p class="text-sm text-gray-400">ค้นหาคำว่า "YOUR_AGORA_APP_ID" ในโค้ด</p>
        </div>
    </div>

    <div v-if="currentView === 'auth'" class="w-full max-w-md">
        <div class="glass-panel p-8 shadow-2xl animate-fade-in">
            <h1 class="text-3xl font-bold text-center mb-2 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
                FutureCall
            </h1>
            <p class="text-center text-gray-400 mb-8">ระบบวิดีโอคอลคุณภาพสูง</p>

            <div v-if="authMode === 'login'">
                <div class="space-y-4">
                    <input v-model="loginForm.name" type="text" placeholder="ชื่อผู้ใช้" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 focus:outline-none focus:border-indigo-500 transition">
                    <input v-model="loginForm.phone" type="tel" placeholder="เบอร์โทรศัพท์" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 focus:outline-none focus:border-indigo-500 transition">
                    <button @click="handleLogin" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-indigo-500/30">
                        เข้าสู่ระบบ
                    </button>
                </div>
                <div class="mt-6 text-center">
                    <span class="text-gray-500">ยังไม่มีบัญชี? </span>
                    <button @click="authMode = 'register'" class="text-indigo-400 hover:text-indigo-300 font-semibold">สร้างบัญชีผู้ใช้</button>
                </div>
            </div>

            <div v-else>
                <div class="space-y-4">
                    <div class="flex justify-center mb-4">
                        <div class="relative w-24 h-24 rounded-full bg-gray-700 overflow-hidden border-2 border-indigo-500 cursor-pointer" @click="$refs.fileInput.click()">
                            <img v-if="registerForm.avatar" :src="registerForm.avatar" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-gray-400">
                                <i class="fas fa-camera text-2xl"></i>
                            </div>
                        </div>
                        <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleFileUpload">
                    </div>
                    <input v-model="registerForm.name" type="text" placeholder="ตั้งชื่อผู้ใช้ (ห้ามซ้ำ)" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 focus:outline-none focus:border-indigo-500">
                    <input v-model="registerForm.phone" type="tel" placeholder="เบอร์โทรศัพท์" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 focus:outline-none focus:border-indigo-500">
                    <button @click="handleRegister" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        ลงทะเบียน
                    </button>
                </div>
                <div class="mt-6 text-center">
                    <button @click="authMode = 'login'" class="text-gray-400 hover:text-white text-sm">ย้อนกลับ</button>
                </div>
            </div>
        </div>
    </div>

    <div v-else-if="currentView === 'dashboard'" class="w-full h-full flex flex-col md:flex-row gap-6 max-w-7xl mx-auto pt-10">
        
        <div class="w-full md:w-1/4 glass-panel p-6 flex flex-col h-fit">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-indigo-500">
                    <img :src="currentUser.avatar || 'https://via.placeholder.com/150'" class="w-full h-full object-cover">
                </div>
                <div>
                    <h2 class="font-bold text-lg">{{ currentUser.name }}</h2>
                    <p class="text-sm text-gray-400">{{ currentUser.phone }}</p>
                    <button @click="openEditProfile" class="text-xs text-indigo-400 mt-1 hover:underline">แก้ไขโปรไฟล์</button>
                </div>
            </div>
            
            <hr class="border-gray-700 mb-6">

            <div class="space-y-3">
                <h3 class="text-gray-400 uppercase text-xs font-bold tracking-wider">เมนู</h3>
                <button @click="createNewRoom" class="w-full text-left p-3 rounded-lg bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 transition flex items-center gap-3">
                    <i class="fas fa-plus-circle"></i> สร้างห้องโทร
                </button>
                <button @click="logout" class="w-full text-left p-3 rounded-lg hover:bg-red-500/20 text-red-400 transition flex items-center gap-3">
                    <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
                </button>
            </div>

            <div class="mt-8 flex-grow">
                <h3 class="text-gray-400 uppercase text-xs font-bold tracking-wider mb-3">ห้องของคุณ</h3>
                <div v-if="myRooms.length === 0" class="text-gray-600 text-sm text-center py-4">ไม่มีประวัติห้อง</div>
                <div v-else class="space-y-2 overflow-y-auto max-h-64">
                    <div v-for="room in myRooms" :key="room.id" @click="joinRoom(room.id)" class="p-3 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700 transition flex justify-between items-center group">
                        <div>
                            <div class="text-sm font-bold text-gray-300">Room {{ room.id }}</div>
                            <div class="text-xs text-gray-500">{{ room.date }}</div>
                        </div>
                        <i class="fas fa-video text-gray-600 group-hover:text-indigo-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 glass-panel p-6 flex flex-col items-center justify-center text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-500/10 to-purple-500/10 z-0"></div>
            
            <div class="z-10 w-full max-w-lg">
                <h1 class="text-4xl font-bold mb-2">เข้าร่วมการประชุม</h1>
                <p class="text-gray-400 mb-8">ใส่รหัสห้อง (Room ID) เพื่อเข้าร่วมวิดีโอคอลทันที</p>
                
                <div class="flex gap-2">
                    <input v-model="joinRoomId" type="text" placeholder="กรอก Room ID ที่นี่..." class="flex-1 bg-gray-800 border-2 border-gray-700 rounded-xl p-4 text-lg focus:border-indigo-500 outline-none transition placeholder-gray-600">
                    <button @click="joinRoom(joinRoomId)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 rounded-xl font-bold text-lg transition shadow-lg shadow-indigo-500/30">
                        เข้าร่วม
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-else-if="currentView === 'room'" class="w-full h-screen flex flex-col bg-gray-900">
        <div class="h-16 glass-panel border-b border-gray-700 flex items-center justify-between px-6 shrink-0 z-20">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 px-3 py-1 rounded text-sm font-bold">ID: {{ activeRoomId }}</div>
                <span class="text-gray-400 text-sm hidden md:inline">| รอเพื่อนเข้าร่วม...</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gray-700 overflow-hidden">
                    <img :src="currentUser.avatar" class="w-full h-full object-cover">
                </div>
                <span class="text-sm font-bold">{{ currentUser.name }}</span>
            </div>
        </div>

        <div class="flex-1 p-4 overflow-y-auto flex items-center justify-center relative">
            <div id="video-grid" class="video-grid content-center">
                <div class="video-container border-2 border-indigo-500" id="local-player">
                    <div class="user-label">{{ currentUser.name }} (คุณ)</div>
                </div>
                </div>
        </div>

        <div class="h-20 glass-panel border-t border-gray-700 flex items-center justify-center gap-4 shrink-0 z-20 pb-2">
            
            <button @click="toggleMic" :class="controls.mic ? 'bg-gray-700 hover:bg-gray-600' : 'bg-red-500 hover:bg-red-600'" class="w-12 h-12 rounded-full flex items-center justify-center transition text-white text-xl">
                <i :class="controls.mic ? 'fas fa-microphone' : 'fas fa-microphone-slash'"></i>
            </button>

            <button @click="toggleCam" :class="controls.cam ? 'bg-gray-700 hover:bg-gray-600' : 'bg-red-500 hover:bg-red-600'" class="w-12 h-12 rounded-full flex items-center justify-center transition text-white text-xl">
                <i :class="controls.cam ? 'fas fa-video' : 'fas fa-video-slash'"></i>
            </button>

            <button @click="shareScreen" :class="controls.screen ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'" class="w-12 h-12 rounded-full flex items-center justify-center transition text-xl">
                <i class="fas fa-desktop"></i>
            </button>

            <button @click="leaveRoom" class="bg-red-600 hover:bg-red-700 w-16 h-12 rounded-full flex items-center justify-center transition text-white text-xl ml-4 shadow-lg shadow-red-500/30">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <div v-if="showEditProfile" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="glass-panel p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">แก้ไขข้อมูลส่วนตัว</h3>
            <div class="space-y-4">
                 <div class="flex justify-center mb-4">
                        <div class="relative w-20 h-20 rounded-full bg-gray-700 overflow-hidden border-2 border-indigo-500 cursor-pointer" @click="$refs.editFileInput.click()">
                            <img :src="editForm.avatar" class="w-full h-full object-cover">
                        </div>
                        <input type="file" ref="editFileInput" class="hidden" accept="image/*" @change="handleEditFileUpload">
                </div>
                <input v-model="editForm.name" class="w-full bg-gray-800 p-2 rounded border border-gray-600" placeholder="ชื่อ">
                <div class="flex gap-2 mt-4">
                    <button @click="saveProfile" class="flex-1 bg-indigo-600 p-2 rounded hover:bg-indigo-700">บันทึก</button>
                    <button @click="showEditProfile = false" class="flex-1 bg-gray-600 p-2 rounded hover:bg-gray-700">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
/**
 * ================= CONFIGURATION =================
 * ใส่ Agora App ID ของคุณตรงนี้ (ฟรีที่ agora.io)
 * หากไม่ใส่จะไม่สามารถโทรได้
 */
const AGORA_APP_ID = 'ebab3ce9350a43c4bf6fb4312a3dbd23'; 

const { createApp, reactive, ref, onMounted } = Vue;

createApp({
    setup() {
        // --- State ---
        const currentView = ref('auth'); // auth, dashboard, room
        const authMode = ref('login');
        const appIdConfigured = ref(true);
        const currentUser = ref(null);
        const myRooms = ref([]);
        
        // Forms
        const loginForm = reactive({ name: '', phone: '' });
        const registerForm = reactive({ name: '', phone: '', avatar: '' });
        const joinRoomId = ref('');
        const activeRoomId = ref('');

        // Edit Profile
        const showEditProfile = ref(false);
        const editForm = reactive({ name: '', avatar: '' });

        // Call State
        const controls = reactive({ mic: true, cam: true, screen: false });
        
        // Agora Vars
        let client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
        let localTracks = { video: null, audio: null, screen: null };
        let remoteUsers = {};

        // --- Lifecycle ---
        onMounted(() => {
            // Check App ID
            if (AGORA_APP_ID === 'YOUR_AGORA_APP_ID' || AGORA_APP_ID === '') {
                appIdConfigured.value = false;
            }

            // Check Login Persistence
            const savedUser = localStorage.getItem('fc_user');
            if (savedUser) {
                currentUser.value = JSON.parse(savedUser);
                loadRooms();
                currentView.value = 'dashboard';
            }
        });

        // --- Auth Logic (Simulated Backend) ---
        const getUsersDB = () => JSON.parse(localStorage.getItem('fc_users_db') || '[]');
        
        const handleRegister = () => {
            if(!registerForm.name || !registerForm.phone) return alert('กรุณากรอกข้อมูลให้ครบ');
            const db = getUsersDB();
            
            if(db.some(u => u.name === registerForm.name)) {
                return alert('ชื่อนี้มีผู้ใช้งานแล้ว');
            }

            const newUser = { ...registerForm, id: Date.now() };
            // Default avatar if none
            if(!newUser.avatar) newUser.avatar = `https://ui-avatars.com/api/?name=${newUser.name}&background=random`;

            db.push(newUser);
            localStorage.setItem('fc_users_db', JSON.stringify(db));
            alert('ลงทะเบียนสำเร็จ! กรุณาเข้าสู่ระบบ');
            authMode.value = 'login';
        };

        const handleLogin = () => {
            const db = getUsersDB();
            const user = db.find(u => u.name === loginForm.name && u.phone === loginForm.phone);
            
            if(user) {
                currentUser.value = user;
                localStorage.setItem('fc_user', JSON.stringify(user));
                loadRooms();
                currentView.value = 'dashboard';
            } else {
                alert('ชื่อหรือเบอร์โทรไม่ถูกต้อง หรือยังไม่ได้ลงทะเบียน');
            }
        };

        const logout = () => {
            localStorage.removeItem('fc_user');
            currentUser.value = null;
            currentView.value = 'auth';
        };

        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => registerForm.avatar = e.target.result;
                reader.readAsDataURL(file);
            }
        };

        // --- Profile Logic ---
        const openEditProfile = () => {
            editForm.name = currentUser.value.name;
            editForm.avatar = currentUser.value.avatar;
            showEditProfile.value = true;
        };

        const handleEditFileUpload = (event) => {
            const file = event.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => editForm.avatar = e.target.result;
                reader.readAsDataURL(file);
            }
        };

        const saveProfile = () => {
            // Update in Memory
            currentUser.value.name = editForm.name;
            currentUser.value.avatar = editForm.avatar;
            // Update in LocalStorage (Session)
            localStorage.setItem('fc_user', JSON.stringify(currentUser.value));
            // Update in DB
            const db = getUsersDB();
            const index = db.findIndex(u => u.phone === currentUser.value.phone); // ID by phone for now
            if(index !== -1) {
                db[index] = currentUser.value;
                localStorage.setItem('fc_users_db', JSON.stringify(db));
            }
            showEditProfile.value = false;
        };

        // --- Room Logic ---
        const loadRooms = () => {
            const rooms = JSON.parse(localStorage.getItem(`fc_rooms_${currentUser.value.phone}`) || '[]');
            myRooms.value = rooms;
        };

        const createNewRoom = () => {
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            const newRoom = { id: roomId, date: new Date().toLocaleString() };
            
            myRooms.value.unshift(newRoom);
            localStorage.setItem(`fc_rooms_${currentUser.value.phone}`, JSON.stringify(myRooms.value));
            
            joinRoom(roomId);
        };

        // --- Agora Video Call Logic ---
        const joinRoom = async (roomId) => {
            if(!roomId) return alert('กรุณาใส่ Room ID');
            if(!appIdConfigured.value) return alert('กรุณาใส่ Agora App ID ในโค้ดก่อน');

            activeRoomId.value = roomId;
            currentView.value = 'room';

            // 1. Join Agora Channel
            // Use roomId as channel name, user.id as uid
            const uid = await client.join(AGORA_APP_ID, roomId, null, currentUser.value.name);

            // 2. Create Local Tracks
            localTracks.audio = await AgoraRTC.createMicrophoneAudioTrack();
            localTracks.video = await AgoraRTC.createCameraVideoTrack();

            // 3. Play Local
            localTracks.video.play("local-player");

            // 4. Publish
            await client.publish([localTracks.audio, localTracks.video]);

            // 5. Handle Remote Users
            client.on("user-published", handleUserPublished);
            client.on("user-unpublished", handleUserUnpublished);
        };

        const handleUserPublished = async (user, mediaType) => {
            await client.subscribe(user, mediaType);
            
            if (mediaType === 'video') {
                const remoteContainer = document.createElement("div");
                remoteContainer.id = `user-${user.uid}`;
                remoteContainer.className = "video-container border border-gray-600";
                
                // Add Name Label
                const label = document.createElement("div");
                label.className = "user-label";
                label.innerText = user.uid; // Agora uses UID as string name here if passed
                remoteContainer.appendChild(label);

                document.getElementById("video-grid").append(remoteContainer);
                user.videoTrack.play(remoteContainer);
            }
            if (mediaType === 'audio') {
                user.audioTrack.play();
            }
        };

        const handleUserUnpublished = (user) => {
            const playerContainer = document.getElementById(`user-${user.uid}`);
            if(playerContainer) playerContainer.remove();
        };

        const leaveRoom = async () => {
            // Close Tracks
            for (let trackName in localTracks) {
                var track = localTracks[trackName];
                if (track) {
                    track.stop();
                    track.close();
                    localTracks[trackName] = undefined;
                }
            }
            // Leave Channel
            await client.leave();
            
            // Clean UI
            document.getElementById("video-grid").innerHTML = `
                <div class="video-container border-2 border-indigo-500" id="local-player">
                    <div class="user-label">${currentUser.value.name} (คุณ)</div>
                </div>`;
            
            currentView.value = 'dashboard';
        };

        // --- Controls ---
        const toggleMic = async () => {
            if(localTracks.audio) {
                controls.mic = !controls.mic;
                await localTracks.audio.setMuted(!controls.mic);
            }
        };

        const toggleCam = async () => {
            if(localTracks.video) {
                controls.cam = !controls.cam;
                await localTracks.video.setMuted(!controls.cam);
            }
        };

        const shareScreen = async () => {
            if(controls.screen) {
                // Stop Sharing
                await client.unpublish(localTracks.screen);
                localTracks.screen.close();
                localTracks.screen = null;
                
                // Switch back to Camera
                await client.publish(localTracks.video);
                localTracks.video.play("local-player");
                controls.screen = false;
            } else {
                // Start Sharing
                try {
                    localTracks.screen = await AgoraRTC.createScreenVideoTrack();
                    await client.unpublish(localTracks.video);
                    await client.publish(localTracks.screen);
                    
                    localTracks.screen.play("local-player");
                    controls.screen = true;

                    // Handle if user clicks "Stop Sharing" on browser UI
                    localTracks.screen.on("track-ended", () => {
                        shareScreen(); // Toggle back
                    });

                } catch (e) {
                    console.error("Screen share failed", e);
                }
            }
        };

        return {
            currentView, authMode, appIdConfigured,
            loginForm, registerForm, currentUser,
            myRooms, joinRoomId, activeRoomId,
            handleRegister, handleLogin, logout, handleFileUpload,
            createNewRoom, joinRoom, leaveRoom,
            controls, toggleMic, toggleCam, shareScreen,
            showEditProfile, editForm, openEditProfile, handleEditFileUpload, saveProfile
        };
    }
}).mount('#app');
</script>
</body>
</html>