<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NextGen Social Call (V5.1 Login Fix)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #007AFF; --bg: #000; --surface: #1c1c1e; --text: #fff; --danger: #ff3b30; --success: #34c759; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* UI Helpers */
        .btn {
            border: none; border-radius: 12px; padding: 12px; cursor: pointer; font-weight: 600; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px; color: white; transition: 0.2s; font-size: 1rem;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-outline { background: transparent; border: 1px solid #444; width: auto; }
        
        input {
            width: 100%; padding: 14px; background: #2c2c2e; border: 1px solid #333;
            border-radius: 10px; color: white; outline: none; margin-bottom: 15px; font-size: 1rem;
        }

        /* Screens */
        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; background: var(--bg); }
        .screen.active { display: flex; }
        
        /* Modal Overlay */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; 
        }
        .modal.active { display: flex; }
        .modal-card { width: 90%; max-width: 400px; background: #1c1c1e; padding: 20px; border-radius: 20px; text-align: center; max-height: 80vh; overflow-y: auto; }

        /* Center Wrap */
        .center-wrap { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 20px; background: radial-gradient(circle, #222 0%, #000 100%); }
        .card-login { width: 100%; max-width: 400px; background: rgba(30,30,30,0.9); padding: 30px; border-radius: 20px; text-align: center; }
        
        /* Link Button Style */
        .link-btn {
            margin-top: 15px; color: var(--primary); cursor: pointer; text-decoration: underline;
            background: none; border: none; font-size: 0.9rem; padding: 5px;
        }

        /* Dashboard */
        #ui-dash { flex-direction: row; }
        .sidebar { width: 320px; background: var(--surface); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #333; z-index: 20; }
        .main-area { flex: 1; background: var(--bg); position: relative; display: flex; align-items: center; justify-content: center; }
        
        /* Mobile Layout */
        .mobile-header { display: none; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mobile-back { display: none; position: absolute; top: 20px; left: 20px; font-size: 1.5rem; cursor: pointer; z-index: 30; }

        @media (max-width: 768px) {
            #ui-dash { flex-direction: column; }
            .sidebar { width: 100%; height: 100%; border: none; }
            .main-area { 
                position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                background: var(--bg); transform: translateX(100%); transition: 0.3s; z-index: 30;
            }
            .main-area.show { transform: translateX(0); }
            .mobile-header { display: flex; }
            .mobile-back { display: block; }
        }

        /* --- FRIEND SYSTEM --- */
        .tab-header { display: flex; justify-content: space-around; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #888; font-size: 1rem; padding: 5px 10px; cursor: pointer; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); font-weight: bold; }
        .friend-list { max-height: 300px; overflow-y: auto; text-align: left; }
        .friend-item { display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; padding: 10px; border-radius: 10px; margin-bottom: 8px; }
        .friend-info { display: flex; align-items: center; gap: 10px; }
        .f-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #444; }

        /* --- 1-ON-1 CALL UI --- */
        #ui-call-p2p { background: #000; flex-direction: column; position: relative; }
        
        .p2p-main-view { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }
        .p2p-profile-view { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; z-index: 2; 
        }
        .p2p-pic-lg { width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; margin-bottom: 15px; }
        
        .p2p-pip-view {
            position: absolute; top: 50px; right: 20px; width: 100px; height: 150px;
            background: #222; border-radius: 12px; overflow: hidden; z-index: 10;
            border: 2px solid #444; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: none;
        }
        .p2p-pip-view.active { display: block; }

        .call-timer {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; z-index: 5;
        }
        
        .switch-cam-btn {
            position: absolute; top: 20px; left: 20px; z-index: 20;
            background: rgba(0,0,0,0.5); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer;
        }

        /* --- CONTROLS --- */
        .controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; background: rgba(40,40,40,0.9); padding: 12px 25px;
            border-radius: 50px; z-index: 20; backdrop-filter: blur(10px);
        }
        .c-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; background: #333; color: white; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .c-btn.active { background: white; color: black; }
        .c-btn.hangup { background: var(--danger); width: 60px; }

        /* Incoming Call Modal */
        .incoming-avatar { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--success); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(46, 213, 115, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0); } }

    </style>
</head>
<body>

    <div id="ui-login" class="screen center-wrap">
        <div class="card-login">
            <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2><br>
            <input type="text" id="l-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
            <input type="tel" id="l-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
            <button class="btn btn-primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="link-btn" onclick="go('register')">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <div id="ui-register" class="screen center-wrap">
        <div class="card-login">
            <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2><br>
            <input type="text" id="r-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)">
            <input type="tel" id="r-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
            <button class="btn btn-primary" onclick="register()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            <button class="link-btn" onclick="go('login')">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="ui-dash" class="screen">
        <div class="sidebar">
            <div class="mobile-header">
                <h3>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" style="width:40px; padding:0;" onclick="openFriendModal()">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button class="btn btn-primary" style="width:40px; padding:0;" onclick="toggleJoin(true)">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <div style="text-align:center; padding-bottom:20px; border-bottom:1px solid #333; margin-bottom:20px;">
                <div style="width:80px; height:80px; margin:0 auto 10px; border-radius:50%; border:2px solid var(--primary); overflow:hidden; position:relative;">
                    <img id="u-pic" src="https://via.placeholder.com/80" style="width:100%; height:100%; object-fit:cover;">
                    <input type="file" id="f-pic" hidden accept="image/*" onchange="savePic(this)">
                    <label for="f-pic" style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); font-size:9px; cursor:pointer;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
                </div>
                <h3 id="u-name">User</h3>
                <p id="u-phone" style="color:#888; font-size:0.9rem;">...</p>
                
                <button class="btn btn-outline" style="margin-top:10px; width:100%; display:none;" id="desktop-add-friend" onclick="openFriendModal()">
                    <i class="fas fa-user-friends"></i> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                </button>
                
                <button class="btn btn-danger" style="margin-top:10px; padding:8px;" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            
            <button class="btn btn-primary" onclick="newRoom()"><i class="fas fa-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (Group)</button>
            <div id="room-list" style="margin-top:20px; overflow-y:auto; flex:1;"></div>
        </div>
        
        <div id="dash-main" class="main-area">
            <div class="mobile-back" onclick="toggleJoin(false)"><i class="fas fa-arrow-left"></i></div>
            <div class="card-login">
                <i class="fas fa-video" style="font-size:3rem; margin-bottom:20px;"></i>
                <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</h3>
                <p style="color:#888; font-size:0.9rem; margin-bottom:15px;">‡πÉ‡∏™‡πà Room ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="join-id" placeholder="Room ID" style="margin-bottom:0;">
                    <button class="btn btn-primary" style="width:80px;" onclick="joinFromInput()">Go</button>
                </div>
            </div>
            
            <button class="btn btn-primary" style="position:absolute; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; box-shadow:0 10px 20px rgba(0,0,0,0.5); z-index:50;" onclick="openFriendModal()">
                <i class="fas fa-user-plus" style="font-size:1.5rem;"></i>
            </button>
        </div>
    </div>

    <div id="modal-friend" class="modal">
        <div class="modal-card">
            <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
            <div class="tab-header">
                <button class="tab-btn active" onclick="switchTab('my-friends')">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
                <button class="tab-btn" onclick="switchTab('find-friends')">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>
            </div>
            
            <div id="tab-my-friends">
                <div id="my-friend-list" class="friend-list"></div>
            </div>

            <div id="tab-find-friends" style="display:none;">
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="text" id="search-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" style="margin-bottom:0;">
                    <button class="btn btn-primary" style="width:auto;" onclick="searchFriend()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
                <div id="search-result-list" class="friend-list"></div>
            </div>
            
            <button class="btn btn-outline" style="margin-top:20px;" onclick="closeModal('modal-friend')">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <div id="modal-incoming" class="modal">
        <div class="modal-card" style="background:#222; border:1px solid var(--success);">
            <img id="inc-pic" src="" class="incoming-avatar">
            <h2 id="inc-name">Name</h2>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏Ñ‡∏∏‡∏ì...</p>
            <div style="display:flex; gap:15px; margin-top:20px;">
                <button class="btn btn-danger" onclick="rejectCall()">‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢</button>
                <button class="btn btn-success" onclick="acceptCall()">‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢</button>
            </div>
        </div>
    </div>

    <div id="ui-call-p2p" class="screen">
        <button class="switch-cam-btn" onclick="switchCamera()"><i class="fas fa-sync-alt"></i></button>
        <div id="p2p-main-cont" style="width:100%; height:100%; position:relative;">
            <div id="p2p-main-video" class="p2p-main-view"></div>
        </div>
        <div id="p2p-pip-cont" class="p2p-pip-view" onclick="swapVideoView()">
            <div id="p2p-pip-video" style="width:100%; height:100%;"></div>
        </div>
        <div id="p2p-profile-ui" class="p2p-profile-view">
            <img id="p2p-u-pic" src="" class="p2p-pic-lg">
            <h2 id="p2p-u-name">Name</h2>
            <p style="color:#ccc;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ô‡∏ó‡∏ô‡∏≤...</p>
        </div>
        <div class="call-timer" id="call-timer">00:00</div>
        <div class="controls">
            <button class="c-btn active" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button class="c-btn active" id="btn-cam" onclick="toggleCam()"><i class="fas fa-video"></i></button>
            <button class="c-btn active" id="btn-vol" onclick="toggleSpeaker()"><i class="fas fa-volume-up"></i></button>
            <button class="c-btn hangup" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <div id="modal-endcall" class="modal">
        <div class="modal-card">
            <h3>‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</h3>
            <img id="end-pic" src="" style="width:80px; height:80px; border-radius:50%; margin:15px auto;">
            <h2 id="end-name">User</h2>
            <p id="end-time" style="color:var(--primary); font-size:1.2rem; margin:10px 0;">00:00</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-outline" onclick="closeModal('modal-endcall')">‡∏≠‡∏≠‡∏Å</button>
                <button class="btn btn-success" onclick="callFriend(lastCallId)">‡πÇ‡∏ó‡∏£‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            </div>
        </div>
    </div>
    
    <div id="ui-video" class="screen" style="background:black; flex-direction:column;">
         <div style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px; z-index:5; color:white;">
            <i class="fas fa-hashtag"></i> <span id="v-room">--</span>
        </div>
        <div id="grid" style="flex:1; display:grid; gap:5px; padding:5px; grid-template-columns: 1fr;"></div>
        <div class="controls">
            <button class="c-btn active" id="g-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button class="c-btn active" id="g-cam" onclick="toggleCam()"><i class="fas fa-video"></i></button>
            <button class="c-btn hangup" onclick="leaveGroup()"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script>
        const APP_ID = "ebab3ce9350a43c4bf6fb4312a3dbd23"; 
        
        let client = AgoraRTC.createClient({ mode: "rtc", codec: "h264" });
        let local = { a:null, v:null };
        let remoteUsers = {};
        let me = null;
        let myFriends = [];
        let callState = { active: false, type: 'none', start: 0, timer: null, friend: null };
        let lastCallId = null;
        let isCamBack = false;

        // --- INIT & BUG FIX ---
        window.onload = () => {
            if(window.innerWidth > 768) document.getElementById('desktop-add-friend').style.display = 'block';
            
            const saved = localStorage.getItem('me');
            if(saved) { 
                me = JSON.parse(saved); 
                renderMe(); 
                loadFriends(); 
                go('dash'); 
            } else {
                go('login'); // üî• ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ User ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }
            
            window.addEventListener('storage', handleSignal);
        };

        // üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô go ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô
        function go(s) { 
            document.querySelectorAll('.screen').forEach(e => e.classList.remove('active')); 
            document.getElementById('ui-'+s).classList.add('active'); 
        }
        
        function toggleJoin(show) { document.getElementById('dash-main').classList.toggle('show', show); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // --- AUTH ---
        function register() {
            const n = document.getElementById('r-name').value.trim();
            const p = document.getElementById('r-phone').value.trim();
            if(!n || !p) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            let db = JSON.parse(localStorage.getItem('db')||"[]");
            if(db.find(u=>u.n===n)) return alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥");
            const newUser = { id: Date.now().toString(), n, p, pic: 'https://via.placeholder.com/80' };
            db.push(newUser); localStorage.setItem('db',JSON.stringify(db));
            alert("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); go('login');
        }
        function login() {
            const n = document.getElementById('l-name').value.trim();
            const p = document.getElementById('l-phone').value.trim();
            let db = JSON.parse(localStorage.getItem('db')||"[]");
            const u = db.find(x=>x.n===n && x.p===p);
            if(u) { me=u; localStorage.setItem('me',JSON.stringify(me)); renderMe(); loadFriends(); go('dash'); }
            else alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }
        function logout() { localStorage.removeItem('me'); location.reload(); }

        function renderMe() {
            document.getElementById('u-name').innerText = me.n;
            document.getElementById('u-phone').innerText = me.p;
            if(me.pic) document.getElementById('u-pic').src = me.pic;
            
            const list = document.getElementById('room-list'); list.innerHTML='';
            let rs = JSON.parse(localStorage.getItem('rooms')||"[]");
            rs.forEach(r => {
                list.innerHTML += `<div style="background:#2a2a2a; padding:10px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:var(--primary); font-weight:bold;">${r.id}</span>
                    <button class="btn btn-primary" style="width:auto; padding:5px 15px; font-size:0.8rem;" onclick="joinGroup('${r.id}')">Join</button>
                </div>`;
            });
        }
        function savePic(e) {
            if(e.files[0]) {
                const r = new FileReader();
                r.onload = ev => {
                    me.pic = ev.target.result; localStorage.setItem('me',JSON.stringify(me));
                    let db = JSON.parse(localStorage.getItem('db')); db[db.findIndex(u=>u.n===me.n)] = me;
                    localStorage.setItem('db',JSON.stringify(db)); renderMe();
                }; r.readAsDataURL(e.files[0]);
            }
        }
        function newRoom() {
            const id = Math.floor(1000+Math.random()*9000).toString();
            let rs = JSON.parse(localStorage.getItem('rooms')||"[]");
            rs.unshift({id, d:new Date().toLocaleDateString()});
            localStorage.setItem('rooms',JSON.stringify(rs)); renderMe(); joinGroup(id);
        }

        // --- FRIEND SYSTEM ---
        function loadFriends() {
            myFriends = JSON.parse(localStorage.getItem('friends_'+me.id) || "[]");
        }
        function openFriendModal() {
            document.getElementById('modal-friend').classList.add('active');
            renderMyFriends();
        }
        function switchTab(t) {
            document.getElementById('tab-my-friends').style.display = t==='my-friends' ? 'block' : 'none';
            document.getElementById('tab-find-friends').style.display = t==='find-friends' ? 'block' : 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
        function renderMyFriends() {
            const l = document.getElementById('my-friend-list'); l.innerHTML = '';
            if(myFriends.length === 0) l.innerHTML = '<p style="color:#666; text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>';
            myFriends.forEach(f => {
                l.innerHTML += `
                <div class="friend-item">
                    <div class="friend-info">
                        <img src="${f.pic}" class="f-pic">
                        <div>
                            <div style="font-weight:bold;">${f.n}</div>
                            <div style="font-size:0.8rem; color:#888;">${f.p}</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-success" style="width:auto; padding:5px 10px;" onclick="callFriend('${f.id}')"><i class="fas fa-phone"></i></button>
                        <button class="btn btn-danger" style="width:auto; padding:5px 10px;" onclick="removeFriend('${f.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
        }
        function searchFriend() {
            const q = document.getElementById('search-input').value.trim();
            if(!q) return;
            let db = JSON.parse(localStorage.getItem('db')||"[]");
            const res = db.filter(u => (u.n.includes(q) || u.p.includes(q)) && u.id !== me.id);
            const l = document.getElementById('search-result-list'); l.innerHTML = '';
            if(res.length === 0) l.innerHTML = '<p style="color:#666; text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>';
            res.forEach(u => {
                const isF = myFriends.find(f => f.id === u.id);
                l.innerHTML += `
                <div class="friend-item">
                    <div class="friend-info">
                        <img src="${u.pic}" class="f-pic">
                        <div>
                            <div>${u.n}</div>
                            <div style="font-size:0.8rem; color:#888;">${u.p}</div>
                        </div>
                    </div>
                    ${!isF ? `<button class="btn btn-primary" style="width:auto; padding:5px 15px;" onclick="addFriend('${u.id}')">‡πÅ‡∏≠‡∏î</button>` : '<span style="color:var(--success); font-size:0.8rem;">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>'}
                </div>`;
            });
        }
        function addFriend(id) {
            let db = JSON.parse(localStorage.getItem('db'));
            const u = db.find(x => x.id === id);
            if(u) {
                myFriends.push(u);
                localStorage.setItem('friends_'+me.id, JSON.stringify(myFriends));
                searchFriend();
            }
        }
        function removeFriend(id) {
            myFriends = myFriends.filter(f => f.id !== id);
            localStorage.setItem('friends_'+me.id, JSON.stringify(myFriends));
            renderMyFriends();
        }

        // --- SIGNALING & CALLING ---
        function callFriend(fid) {
            closeModal('modal-friend'); closeModal('modal-endcall');
            lastCallId = fid;
            const f = myFriends.find(x => x.id === fid) || JSON.parse(localStorage.getItem('db')).find(x=>x.id===fid);
            callState.friend = f;
            
            localStorage.setItem('signal_call', JSON.stringify({
                from: me, to: f.id, type: 'offer', time: Date.now()
            }));
            
            go('call-p2p');
            document.getElementById('p2p-u-name').innerText = f.n;
            document.getElementById('p2p-u-pic').src = f.pic;
            document.getElementById('p2p-profile-ui').querySelector('p').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏£...";
        }

        function handleSignal(e) {
            if(e.key === 'signal_call') {
                const data = JSON.parse(e.newValue);
                if(!data) return;
                
                if(data.to === me.id && data.type === 'offer' && (Date.now() - data.time < 5000)) {
                    document.getElementById('inc-name').innerText = data.from.n;
                    document.getElementById('inc-pic').src = data.from.pic;
                    document.getElementById('modal-incoming').classList.add('active');
                    callState.friend = data.from;
                }
                
                if(data.to === me.id && data.type === 'answer') {
                    startP2PSession();
                }

                if(data.to === me.id && data.type === 'reject') {
                    alert("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢");
                    go('dash');
                }
            }
        }

        function acceptCall() {
            closeModal('modal-incoming');
            localStorage.setItem('signal_call', JSON.stringify({
                from: me, to: callState.friend.id, type: 'answer', time: Date.now()
            }));
            startP2PSession();
        }
        
        function rejectCall() {
            closeModal('modal-incoming');
            localStorage.setItem('signal_call', JSON.stringify({
                from: me, to: callState.friend.id, type: 'reject', time: Date.now()
            }));
        }

        // --- AGORA P2P LOGIC ---
        async function startP2PSession() {
            const ids = [me.id, callState.friend.id].sort();
            const roomId = `p2p_${ids[0]}_${ids[1]}`;
            
            go('call-p2p');
            document.getElementById('p2p-u-name').innerText = callState.friend.n;
            document.getElementById('p2p-u-pic').src = callState.friend.pic;
            document.getElementById('p2p-profile-ui').querySelector('p').innerText = "‡∏™‡∏ô‡∏ó‡∏ô‡∏≤";
            document.getElementById('p2p-profile-ui').style.display = 'block';
            document.getElementById('p2p-pip-cont').classList.remove('active');

            callState.start = Date.now();
            callState.timer = setInterval(() => {
                const diff = Math.floor((Date.now() - callState.start)/1000);
                const m = Math.floor(diff/60).toString().padStart(2,'0');
                const s = (diff%60).toString().padStart(2,'0');
                document.getElementById('call-timer').innerText = `${m}:${s}`;
            }, 1000);

            try {
                await client.join(APP_ID, roomId, null, me.id);
                [local.a, local.v] = await AgoraRTC.createMicrophoneAndCameraTracks();
                await client.publish([local.a, local.v]);
                updateP2PLayout();
                
            } catch(e) { console.error(e); }
        }

        function endCall() {
            if(local.a) { local.a.close(); local.v.close(); }
            client.leave();
            clearInterval(callState.timer);
            
            go('dash');
            document.getElementById('modal-endcall').classList.add('active');
            document.getElementById('end-name').innerText = callState.friend.n;
            document.getElementById('end-pic').src = callState.friend.pic;
            document.getElementById('end-time').innerText = document.getElementById('call-timer').innerText;
            
            local = {a:null, v:null};
            document.getElementById('p2p-main-video').innerHTML = '';
            document.getElementById('p2p-pip-video').innerHTML = '';
        }

        // --- P2P VIDEO LAYOUT LOGIC ---
        let isPipSwapped = false; 

        client.on("user-published", async (user, mediaType) => {
            await client.subscribe(user, mediaType);
            remoteUsers[user.uid] = user;
            if(mediaType === "video") updateP2PLayout();
            if(mediaType === "audio") user.audioTrack.play();
        });
        
        client.on("user-unpublished", (user, type) => {
            if(type === 'video') updateP2PLayout();
        });

        function updateP2PLayout() {
            const remUser = Object.values(remoteUsers)[0];
            const hasRemote = remUser && remUser.videoTrack;
            const hasLocal = local.v && !local.v.muted;

            const mainDiv = document.getElementById('p2p-main-video');
            const pipDiv = document.getElementById('p2p-pip-video');
            const pipCont = document.getElementById('p2p-pip-cont');
            const profileUI = document.getElementById('p2p-profile-ui');

            profileUI.style.display = 'block';
            pipCont.classList.remove('active');
            
            if (hasRemote && hasLocal) {
                profileUI.style.display = 'none';
                pipCont.classList.add('active');
                if(!isPipSwapped) { remUser.videoTrack.play(mainDiv); local.v.play(pipDiv); }
                else { local.v.play(mainDiv); remUser.videoTrack.play(pipDiv); }
            } else if (hasRemote) {
                profileUI.style.display = 'none';
                remUser.videoTrack.play(mainDiv);
            } else if (hasLocal) {
                profileUI.style.display = 'none';
                local.v.play(mainDiv);
            } else {
                profileUI.style.display = 'block';
                mainDiv.innerHTML = '';
            }
        }
        
        function swapVideoView() {
            isPipSwapped = !isPipSwapped;
            updateP2PLayout();
        }
        
        async function switchCamera() {
            if(local.v) {
                try {
                    local.v.close();
                    isCamBack = !isCamBack;
                    local.v = await AgoraRTC.createCameraVideoTrack({ facingMode: isCamBack ? "environment" : "user" });
                    const audio = local.a;
                    await client.publish(local.v);
                    updateP2PLayout();
                } catch(e) { console.error(e); }
            }
        }

        // --- GROUP CALL (Legacy) ---
        function joinGroup(rid) {
            go('video'); document.getElementById('v-room').innerText = rid;
            startGroupSession(rid);
        }
        async function startGroupSession(rid) {
            try {
                await client.join(APP_ID, rid, null, me.id);
                [local.a, local.v] = await AgoraRTC.createMicrophoneAndCameraTracks();
                await client.publish([local.a, local.v]);
                addGridVid(me.id, local.v, true);
            } catch(e) { console.error(e); }
        }
        function addGridVid(uid, track, isMe) {
            const d = document.createElement('div'); 
            d.style.cssText = "background:#222; border-radius:10px; overflow:hidden; position:relative; min-height:200px;";
            d.id = `g-${uid}`;
            d.innerHTML = `<div id="play-g-${uid}" style="width:100%; height:100%;"></div>`;
            document.getElementById('grid').appendChild(d);
            track.play(`play-g-${uid}`);
        }
        function leaveGroup() {
            if(local.a) { local.a.close(); local.v.close(); }
            client.leave(); document.getElementById('grid').innerHTML=''; go('dash');
        }

        function toggleMic() { if(local.a) { local.a.setMuted(!local.a.muted); updateBtns(); } }
        function toggleCam() { if(local.v) { local.v.setMuted(!local.v.muted); updateBtns(); updateP2PLayout(); } }
        function toggleSpeaker() { }
        function updateBtns() {
            document.querySelectorAll('#btn-mic, #g-mic').forEach(b => b.className = `c-btn ${local.a?.muted ? 'off' : 'active'}`);
            document.querySelectorAll('#btn-cam, #g-cam').forEach(b => b.className = `c-btn ${local.v?.muted ? 'off' : 'active'}`);
        }
        function joinFromInput() { const v = document.getElementById('join-id').value; if(v) joinGroup(v); }
    </script>
</body>
</html>