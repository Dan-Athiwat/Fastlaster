<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NextGen Public Call</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: white; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.95); }
        
        /* Video Grid Layout */
        #video-grid { 
            display: grid; 
            gap: 8px; 
            width: 100%; 
            height: 100%; 
            padding: 8px;
            box-sizing: border-box;
            /* Default for 1 person */
            grid-template-columns: 1fr;
        }
        
        .video-container { 
            position: relative; 
            background: #262626; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
        }
        .video-player { width: 100%; height: 100%; object-fit: cover; }

        /* Hide Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Control Bar Animation */
        #controls-bar { transition: transform 0.3s ease, opacity 0.3s ease; }
        .controls-hidden { transform: translateY(150%); opacity: 0; pointer-events: none; }

        @media (max-width: 768px) {
            .mobile-hidden { display: none !important; }
            .mobile-full { position: fixed; inset: 0; z-index: 50; background: #0f172a; }
        }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900 bg-[url('https://source.unsplash.com/random/1920x1080/?cyberpunk')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div class="relative glass-panel p-8 rounded-2xl shadow-2xl w-96 text-center">
            <h1 class="text-3xl font-bold mb-2 text-indigo-400">เข้าสู่ระบบ</h1>
            <p class="text-gray-400 mb-6 text-sm">ระบบโทรสาธารณะ (Public Call)</p>
            <input type="text" id="login-name" placeholder="ชื่อของคุณ" class="w-full p-3 mb-4 rounded-lg bg-slate-800 border border-slate-600 text-white outline-none focus:border-indigo-500">
            <input type="tel" id="login-phone" placeholder="เบอร์โทรศัพท์" class="w-full p-3 mb-6 rounded-lg bg-slate-800 border border-slate-600 text-white outline-none focus:border-indigo-500">
            <button onclick="handleLogin()" class="w-full py-3 rounded-lg btn-primary font-bold text-lg shadow-lg">เริ่มต้นใช้งาน</button>
            <p class="mt-4 text-sm text-gray-500">ยังไม่มีชื่อ? <span onclick="showRegister()" class="text-indigo-400 cursor-pointer underline">สร้างใหม่</span></p>
        </div>
    </div>

    <div id="register-screen" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-slate-900">
        <div class="glass-panel p-8 rounded-2xl shadow-2xl w-96 text-center">
            <h1 class="text-2xl font-bold mb-6 text-white">สร้างบัญชีใหม่</h1>
            <div class="relative w-24 h-24 mx-auto mb-4 cursor-pointer group" onclick="document.getElementById('reg-avatar-input').click()">
                <img id="reg-avatar-preview" src="https://via.placeholder.com/150" class="w-full h-full rounded-full object-cover border-2 border-indigo-500">
                <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fas fa-camera"></i></div>
            </div>
            <input type="file" id="reg-avatar-input" accept="image/*" class="hidden" onchange="previewAvatar(event)">
            <input type="text" id="reg-name" placeholder="ตั้งชื่อผู้ใช้ (ห้ามซ้ำ)" class="w-full p-3 mb-4 rounded-lg bg-slate-800 border border-slate-600 text-white">
            <input type="tel" id="reg-phone" placeholder="เบอร์โทรศัพท์" class="w-full p-3 mb-6 rounded-lg bg-slate-800 border border-slate-600 text-white">
            <button onclick="handleRegister()" class="w-full py-3 rounded-lg btn-primary font-bold">ยืนยัน</button>
            <button onclick="showLogin()" class="mt-3 text-gray-400 text-sm">ยกเลิก</button>
        </div>
    </div>

    <div id="main-dashboard" class="hidden h-screen flex flex-row bg-slate-900">
        <div id="sidebar-panel" class="w-full md:w-80 bg-slate-800 flex flex-col h-full z-10 border-r border-slate-700">
            <div class="p-4 bg-slate-900/50 flex items-center justify-between border-b border-slate-700">
                <div class="flex items-center gap-3 cursor-pointer" onclick="openProfileEdit()">
                    <img id="dash-avatar" src="" class="w-12 h-12 rounded-full border border-indigo-500 object-cover">
                    <div>
                        <h3 id="dash-name" class="font-bold text-white truncate w-24">User</h3>
                        <p id="dash-uid" class="text-xs text-indigo-400">ID: ...</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="showMobileSearch()" class="md:hidden p-2 rounded bg-slate-700 text-white"><i class="fas fa-search"></i></button>
                    <button onclick="logout()" class="p-2 rounded bg-red-900/50 text-red-400"><i class="fas fa-power-off"></i></button>
                </div>
            </div>

            <div class="p-4">
                <button onclick="createRoom()" class="w-full py-3 rounded-xl btn-primary font-bold shadow-lg flex justify-center items-center gap-2">
                    <i class="fas fa-video"></i> สร้างห้องใหม่
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-3" id="room-list">
                <p class="text-xs text-gray-500 text-center">ประวัติห้องที่คุณสร้าง</p>
            </div>
        </div>

        <div id="content-panel" class="mobile-hidden flex-1 flex flex-col relative bg-slate-950">
            <div class="h-16 border-b border-slate-800 flex items-center px-4 justify-between bg-slate-900 z-20">
                <button onclick="hideMobileSearch()" class="md:hidden text-white mr-3"><i class="fas fa-arrow-left"></i></button>
                <h2 class="font-bold text-lg hidden md:block text-gray-200">Public Lobby</h2>
                
                <div class="flex items-center gap-0 w-full md:w-auto ml-auto">
                    <input type="text" id="join-room-id" placeholder="กรอก ID ห้องเพื่อน (เช่น 123456)" class="bg-slate-800 px-4 py-2 rounded-l-lg border border-slate-700 focus:border-indigo-500 outline-none w-full md:w-64 text-sm">
                    <button onclick="joinRoomFromInput()" class="bg-indigo-600 px-4 py-2 rounded-r-lg hover:bg-indigo-700 font-bold text-sm whitespace-nowrap">เข้าร่วม</button>
                </div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center text-gray-600">
                <i class="fas fa-globe-asia text-6xl mb-4 opacity-20"></i>
                <p>กรอก ID ห้องเพื่อเข้าร่วมสนทนา</p>
            </div>
        </div>
    </div>

    <div id="video-overlay" class="hidden fixed inset-0 z-[100] bg-black">
        <div class="absolute top-4 left-4 z-20 flex gap-2">
            <div class="bg-black/60 backdrop-blur px-4 py-2 rounded-full flex items-center gap-2 border border-white/10">
                <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                <span class="text-sm font-mono" id="current-room-id">ID: --</span>
                <button onclick="copyRoomID()" class="text-gray-400 hover:text-white"><i class="far fa-copy"></i></button>
            </div>
            <div class="bg-black/60 backdrop-blur px-3 py-2 rounded-full border border-white/10 text-sm text-indigo-300">
                <i class="fas fa-users"></i> <span id="participant-count">1</span>/6
            </div>
        </div>

        <div id="video-grid" onclick="toggleControlsVisibility()">
            </div>

        <div id="controls-bar" class="absolute bottom-6 left-0 right-0 z-20 flex justify-center pointer-events-none">
            <div class="bg-slate-900/90 backdrop-blur-xl border border-white/10 px-6 py-3 rounded-full flex items-center gap-4 shadow-2xl pointer-events-auto">
                <button onclick="toggleMic()" id="btn-mic" class="w-12 h-12 rounded-full bg-slate-700 text-white flex items-center justify-center text-xl hover:bg-slate-600"><i class="fas fa-microphone"></i></button>
                <button onclick="toggleCam()" id="btn-cam" class="w-12 h-12 rounded-full bg-slate-700 text-white flex items-center justify-center text-xl hover:bg-slate-600"><i class="fas fa-video"></i></button>
                <button onclick="toggleScreenShare()" id="btn-screen" class="hidden md:flex w-12 h-12 rounded-full bg-slate-700 text-white items-center justify-center text-xl hover:bg-slate-600"><i class="fas fa-desktop"></i></button>
                <button onclick="switchCamera()" class="md:hidden w-12 h-12 rounded-full bg-slate-700 text-white flex items-center justify-center text-xl hover:bg-slate-600"><i class="fas fa-sync-alt"></i></button>
                <button onclick="leaveRoom()" class="w-14 h-14 rounded-full bg-red-600 text-white flex items-center justify-center text-2xl shadow-lg hover:bg-red-700 hover:scale-105 transition"><i class="fas fa-phone-slash"></i></button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="hidden fixed inset-0 z-[120] flex items-center justify-center bg-black/80 backdrop-blur">
        <div class="glass-panel p-6 rounded-2xl w-80 text-center relative bg-slate-900">
            <button onclick="closeProfileEdit()" class="absolute top-3 right-3 text-gray-400"><i class="fas fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4">แก้ไขโปรไฟล์</h3>
            <div class="relative w-20 h-20 mx-auto mb-4" onclick="document.getElementById('edit-avatar-input').click()">
                <img id="edit-avatar-preview" src="" class="w-full h-full rounded-full object-cover border-2 border-indigo-500">
                <i class="fas fa-pen absolute bottom-0 right-0 bg-white text-black p-1 rounded-full text-xs"></i>
            </div>
            <input type="file" id="edit-avatar-input" class="hidden" onchange="previewEditAvatar(event)">
            <input type="text" id="edit-name" class="w-full p-2 mb-4 rounded bg-slate-800 text-white border border-slate-600">
            <button onclick="saveProfile()" class="w-full py-2 btn-primary rounded">บันทึก</button>
        </div>
    </div>

    <script>
        // ============================================
        // ⚡️ SETUP KEY: เปลี่ยน APP ID ตรงนี้เพื่อให้เชื่อมกันได้ ⚡️
        // สมัคร Agora.io ฟรี > สร้าง Project > เลือก App ID
        // ============================================
        const AGORA_APP_ID = 'ebab3ce9350a43c4bf6fb4312a3dbd23'; 

        // State
        let currentUser = null;
        let createdRooms = [];
        let rtc = { client: null, localAudio: null, localVideo: null, screen: null, micOn: true, camOn: true, sharing: false };
        let controlsTimeout;

        // Init
        window.onload = () => {
            if(localStorage.getItem('vc_user')) {
                currentUser = JSON.parse(localStorage.getItem('vc_user'));
                loadDashboard();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
            if(localStorage.getItem('vc_rooms')) createdRooms = JSON.parse(localStorage.getItem('vc_rooms'));
            
            // Listeners for UI interaction
            document.addEventListener('mousemove', resetControls);
            document.addEventListener('touchstart', resetControls);
        };

        // --- AUTH ---
        function handleLogin() {
            const name = document.getElementById('login-name').value.trim();
            const phone = document.getElementById('login-phone').value.trim();
            if(!name || !phone) return alert('กรุณากรอกข้อมูล');
            
            // Simple Local Auth
            const users = JSON.parse(localStorage.getItem('vc_users') || '[]');
            const user = users.find(u => u.name === name && u.phone === phone);
            if(user) {
                currentUser = user;
                localStorage.setItem('vc_user', JSON.stringify(user));
                loadDashboard();
            } else {
                alert('ไม่พบผู้ใช้ กรุณาสมัครใหม่');
            }
        }

        function handleRegister() {
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            if(!name || !phone) return alert('กรุณากรอกข้อมูล');

            let users = JSON.parse(localStorage.getItem('vc_users') || '[]');
            if(users.some(u => u.name === name)) return alert('ชื่อซ้ำ');

            // Generate ID starting from 100
            let newId = 100;
            if(users.length > 0) newId = parseInt(users[users.length-1].displayId) + 1;

            const newUser = {
                name, phone, 
                avatar: document.getElementById('reg-avatar-preview').src || 'https://via.placeholder.com/150',
                displayId: newId,
                uid: Math.floor(Math.random() * 10000) // Random UID for Agora
            };

            users.push(newUser);
            localStorage.setItem('vc_users', JSON.stringify(users));
            alert('สมัครเสร็จสิ้น! ID: ' + newId);
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        // --- DASHBOARD ---
        function loadDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('dash-name').textContent = currentUser.name;
            document.getElementById('dash-uid').textContent = 'ID: ' + currentUser.displayId;
            document.getElementById('dash-avatar').src = currentUser.avatar;
            renderRooms();
        }

        function createRoom() {
            const roomId = Math.floor(100000 + Math.random() * 900000).toString(); // 6 Digit Public ID
            createdRooms.push({ id: roomId, name: `Room ${roomId}` });
            localStorage.setItem('vc_rooms', JSON.stringify(createdRooms));
            renderRooms();
            joinRoom(roomId);
        }

        function renderRooms() {
            const list = document.getElementById('room-list');
            list.innerHTML = '';
            createdRooms.forEach(r => {
                list.innerHTML += `
                <div class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <div>
                        <div class="font-bold text-indigo-300">ห้องส่วนตัว</div>
                        <div class="text-xs text-gray-400">ID: ${r.id}</div>
                    </div>
                    <button onclick="joinRoom('${r.id}')" class="px-3 py-1 bg-indigo-600 rounded text-xs hover:bg-indigo-500">เข้า</button>
                </div>`;
            });
        }

        // --- VIDEO CALL (AGORA) ---
        function joinRoomFromInput() {
            const id = document.getElementById('join-room-id').value.trim();
            if(id) joinRoom(id);
        }

        async function joinRoom(roomId) {
            if(AGORA_APP_ID === 'YOUR_AGORA_APP_ID') return alert('⚠️ Error: กรุณาใส่ Agora App ID ในโค้ดบรรทัด 164 ก่อน');

            // UI Prep
            document.getElementById('video-overlay').classList.remove('hidden');
            document.getElementById('current-room-id').textContent = 'ID: ' + roomId;
            document.getElementById('video-grid').innerHTML = '';
            
            rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

            // Listeners
            rtc.client.on("user-published", handleUserPublished);
            rtc.client.on("user-unpublished", handleUserUnpublished);
            rtc.client.on("user-joined", updateCount);
            rtc.client.on("user-left", updateCount);

            try {
                // Join
                await rtc.client.join(AGORA_APP_ID, roomId, null, currentUser.uid);

                // Check Limit (Max 6: 1 Local + 5 Remote)
                if (rtc.client.getRemoteUsers().length >= 5) {
                    alert('ห้องเต็มแล้ว (สูงสุด 6 คน)');
                    leaveRoom();
                    return;
                }

                // Create Tracks
                [rtc.localAudio, rtc.localVideo] = await AgoraRTC.createMicrophoneAndCameraTracks();
                await rtc.client.publish([rtc.localAudio, rtc.localVideo]);

                // Play Local
                addVideoPlayer(currentUser.uid, true, rtc.localVideo);
                updateCount();
                resetControls();

            } catch (err) {
                console.error(err);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ (ตรวจสอบ HTTPS)');
                leaveRoom();
            }
        }

        async function handleUserPublished(user, mediaType) {
            await rtc.client.subscribe(user, mediaType);
            if (mediaType === "video") {
                addVideoPlayer(user.uid, false, user.videoTrack);
            }
            if (mediaType === "audio") {
                user.audioTrack.play();
            }
            updateCount();
        }

        function handleUserUnpublished(user) {
            const el = document.getElementById(`user-container-${user.uid}`);
            if(el) el.remove();
            updateGrid();
            updateCount();
        }

        function addVideoPlayer(uid, isLocal, track) {
            // Prevent duplicate
            if(document.getElementById(`user-container-${uid}`)) return;

            const div = document.createElement('div');
            div.id = `user-container-${uid}`;
            div.className = `video-container ${isLocal ? 'border-2 border-indigo-500' : ''}`;
            div.innerHTML = `
                <div id="video-${uid}" class="video-player"></div>
                <div class="absolute bottom-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded backdrop-blur-md">
                    ${isLocal ? 'คุณ (Me)' : `User ${uid}`}
                </div>
            `;
            document.getElementById('video-grid').append(div);
            track.play(`video-${uid}`);
            updateGrid();
        }

        function updateGrid() {
            const grid = document.getElementById('video-grid');
            const count = grid.children.length;
            const isMobile = window.innerWidth < 768;

            // Smart Grid Logic
            if(count === 1) {
                grid.style.gridTemplateColumns = "1fr";
                grid.style.gridTemplateRows = "1fr";
            } else if(count === 2) {
                grid.style.gridTemplateColumns = isMobile ? "1fr" : "1fr 1fr";
                grid.style.gridTemplateRows = isMobile ? "1fr 1fr" : "1fr";
            } else if(count <= 4) {
                grid.style.gridTemplateColumns = "1fr 1fr";
                grid.style.gridTemplateRows = "1fr 1fr";
            } else {
                // 5-6 Users
                grid.style.gridTemplateColumns = isMobile ? "1fr 1fr" : "1fr 1fr 1fr";
                grid.style.gridTemplateRows = "1fr 1fr"; 
            }
        }
        
        function updateCount() {
            // Local + Remote
            const count = (rtc.client ? rtc.client.getRemoteUsers().length : 0) + 1;
            document.getElementById('participant-count').textContent = count;
        }

        async function leaveRoom() {
            if(rtc.localAudio) { rtc.localAudio.close(); rtc.localAudio = null; }
            if(rtc.localVideo) { rtc.localVideo.close(); rtc.localVideo = null; }
            if(rtc.client) { await rtc.client.leave(); rtc.client = null; }
            document.getElementById('video-overlay').classList.add('hidden');
        }

        // --- CONTROLS ---
        function toggleControlsVisibility() {
            const bar = document.getElementById('controls-bar');
            bar.classList.toggle('controls-hidden');
            if(!bar.classList.contains('controls-hidden')) resetControls();
        }

        function resetControls() {
            const bar = document.getElementById('controls-bar');
            if(!document.getElementById('video-overlay').classList.contains('hidden')) {
                bar.classList.remove('controls-hidden');
                clearTimeout(controlsTimeout);
                controlsTimeout = setTimeout(() => bar.classList.add('controls-hidden'), 5000);
            }
        }

        function toggleMic() {
            if(rtc.localAudio) {
                rtc.micOn = !rtc.micOn;
                rtc.localAudio.setEnabled(rtc.micOn);
                updateBtn('btn-mic', rtc.micOn);
            }
        }

        function toggleCam() {
            if(rtc.localVideo) {
                rtc.camOn = !rtc.camOn;
                rtc.localVideo.setEnabled(rtc.camOn);
                updateBtn('btn-cam', rtc.camOn);
            }
        }

        function updateBtn(id, active) {
            const el = document.getElementById(id);
            if(active) {
                el.classList.remove('bg-red-500');
                el.classList.add('bg-slate-700');
                el.innerHTML = id.includes('mic') ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-video"></i>';
            } else {
                el.classList.add('bg-red-500');
                el.classList.remove('bg-slate-700');
                el.innerHTML = id.includes('mic') ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-video-slash"></i>';
            }
        }

        async function switchCamera() {
            if(rtc.localVideo) {
                const cams = await AgoraRTC.getCameras();
                const current = rtc.localVideo.getMediaStreamTrack().getSettings().deviceId;
                const next = cams.find(c => c.deviceId !== current) || cams[0];
                if(next) await rtc.localVideo.setDevice(next.deviceId);
            }
        }

        async function toggleScreenShare() {
            if(!rtc.sharing) {
                rtc.screen = await AgoraRTC.createScreenVideoTrack();
                await rtc.client.unpublish(rtc.localVideo);
                await rtc.client.publish(rtc.screen);
                rtc.screen.play(`video-${currentUser.uid}`);
                rtc.sharing = true;
                document.getElementById('btn-screen').classList.add('bg-green-500');
                rtc.screen.on("track-ended", toggleScreenShare);
            } else {
                await rtc.client.unpublish(rtc.screen);
                rtc.screen.close();
                await rtc.client.publish(rtc.localVideo);
                rtc.localVideo.play(`video-${currentUser.uid}`);
                rtc.sharing = false;
                document.getElementById('btn-screen').classList.remove('bg-green-500');
            }
        }

        // --- UTILS ---
        function showRegister() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('register-screen').classList.remove('hidden'); }
        function showLogin() { document.getElementById('register-screen').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }
        function previewAvatar(e) { const r = new FileReader(); r.onload=()=>document.getElementById('reg-avatar-preview').src=r.result; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); }
        function previewEditAvatar(e) { const r = new FileReader(); r.onload=()=>document.getElementById('edit-avatar-preview').src=r.result; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); }
        function logout() { localStorage.removeItem('vc_user'); location.reload(); }
        function showMobileSearch() { document.getElementById('sidebar-panel').classList.add('mobile-hidden'); document.getElementById('content-panel').classList.remove('mobile-hidden'); document.getElementById('content-panel').classList.add('mobile-full'); }
        function hideMobileSearch() { document.getElementById('sidebar-panel').classList.remove('mobile-hidden'); document.getElementById('content-panel').classList.add('mobile-hidden'); document.getElementById('content-panel').classList.remove('mobile-full'); }
        function openProfileEdit() { document.getElementById('profile-modal').classList.remove('hidden'); document.getElementById('edit-name').value = currentUser.name; document.getElementById('edit-avatar-preview').src = currentUser.avatar; }
        function closeProfileEdit() { document.getElementById('profile-modal').classList.add('hidden'); }
        function saveProfile() { currentUser.name = document.getElementById('edit-name').value; currentUser.avatar = document.getElementById('edit-avatar-preview').src; localStorage.setItem('vc_user', JSON.stringify(currentUser)); loadDashboard(); closeProfileEdit(); }
        function copyRoomID() { navigator.clipboard.writeText(document.getElementById('current-room-id').textContent.replace('ID: ', '')); }
    </script>
</body>
</html>