<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChatApp v2.0 - Premium Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-solid: #667eea;
            --bg: #f3f4f6;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
            --red: #ff4757;
            --green: #2ed573;
            --text-main: #2d3436;
            --text-sec: #636e72;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; display: flex; color: var(--text-main); }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed; inset: 0; background: var(--primary); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white;
        }
        .login-card {
            background: rgba(255,255,255,0.2); backdrop-filter: blur(10px);
            padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .google-btn {
            background: white; color: #444; padding: 12px 24px; border: none; border-radius: 50px;
            font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px;
            margin-top: 20px; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .google-btn:active { transform: scale(0.95); }

        /* --- Main Layout --- */
        #app-container { display: none; width: 100%; height: 100%; max-width: 1600px; margin: 0 auto; background: white; box-shadow: var(--shadow); }

        /* Sidebar (Left) */
        .sidebar {
            width: 350px; background: var(--glass); border-right: 1px solid #eee;
            display: flex; flex-direction: column; z-index: 10;
        }
        .my-profile {
            padding: 20px; background: white; display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .avatar {
            width: 50px; height: 50px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--primary-solid); padding: 2px;
        }
        .user-info h3 { margin: 0; font-size: 18px; font-weight: 600; }
        .status-badge { display: inline-block; width: 8px; height: 8px; background: var(--green); border-radius: 50%; margin-right: 5px; }
        
        .search-area { padding: 15px; }
        .search-box {
            display: flex; background: #f1f2f6; border-radius: 15px; padding: 5px 15px; align-items: center;
        }
        .search-box input {
            border: none; background: transparent; padding: 10px; flex: 1; outline: none; font-family: 'Kanit';
        }
        .add-btn {
            background: var(--primary-solid); color: white; border: none; width: 35px; height: 35px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .err-msg { color: var(--red); font-size: 12px; margin-top: 5px; margin-left: 10px; display: none; }

        .friend-list { flex: 1; overflow-y: auto; padding: 10px; }
        .friend-item {
            display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 15px;
            cursor: pointer; transition: background 0.2s; margin-bottom: 5px;
        }
        .friend-item:hover { background: #f8f9fa; }
        .friend-item.active { background: #eef2ff; border-left: 4px solid var(--primary-solid); }

        /* Chat Area (Right) */
        .chat-area {
            flex: 1; display: flex; flex-direction: column; background: #fff; position: relative;
        }
        .chat-header {
            padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
        }
        .back-btn { display: none; font-size: 24px; border: none; background: none; margin-right: 10px; cursor: pointer; }
        
        .messages {
            flex: 1; overflow-y: auto; padding: 20px; background-image: radial-gradient(#e1e1e1 1px, transparent 1px);
            background-size: 20px 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .message {
            max-width: 75%; padding: 12px 18px; border-radius: 20px; font-size: 15px; line-height: 1.5; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        
        .msg-me {
            align-self: flex-end; background: var(--primary); color: white;
            border-bottom-right-radius: 5px;
        }
        .msg-friend {
            align-self: flex-start; background: white; color: var(--text-main); border: 1px solid #eee;
            border-bottom-left-radius: 5px;
        }
        .msg-img { max-width: 100%; border-radius: 10px; margin-top: 5px; }

        .input-bar {
            padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center;
        }
        .attach-btn { font-size: 24px; cursor: pointer; color: #aaa; padding: 0 10px; }
        .msg-input {
            flex: 1; padding: 12px 20px; border-radius: 30px; border: 1px solid #eee; background: #f9f9f9; outline: none; font-family: 'Kanit';
        }
        .send-btn {
            width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* --- Modals --- */
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
            justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-box {
            background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; position: relative;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .close-btn {
            position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa;
        }
        .modal-box input[type="text"] { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; }
        .save-btn { width: 100%; padding: 12px; background: var(--green); color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }
        
        /* --- Call Screen --- */
        #call-screen {
            display: none; position: fixed; inset: 0; background: #222;
            flex-direction: column; justify-content: center; align-items: center; z-index: 3000;
            background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://source.unsplash.com/random/1920x1080/?nature');
            background-size: cover; color: white;
        }
        .call-pulse {
            width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid white;
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); animation: pulse-white 2s infinite;
        }
        @keyframes pulse-white { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { box-shadow: 0 0 0 30px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }
        
        .call-actions { display: flex; gap: 40px; margin-top: 50px; }
        .action-btn {
            width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 30px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: transform 0.2s;
        }
        .action-btn:active { transform: scale(0.9); }
        .btn-reject { background: var(--red); color: white; }
        .btn-answer { background: var(--green); color: white; }

        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; transition: transform 0.3s ease; }
            .chat-area { width: 100%; position: absolute; height: 100%; transform: translateX(100%); transition: transform 0.3s ease; }
            
            /* State: Viewing List */
            body.view-list .sidebar { transform: translateX(0); }
            body.view-list .chat-area { transform: translateX(100%); }
            
            /* State: Viewing Chat */
            body.view-chat .sidebar { transform: translateX(-20%); }
            body.view-chat .chat-area { transform: translateX(0); }
            
            .back-btn { display: block; }
            #app-container { border-radius: 0; }
        }
        
        /* Helpers */
        .hidden { display: none !important; }
        .badge-req { background: var(--red); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: auto; }
    </style>
</head>
<body class="view-list"> <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <div id="login-screen">
        <div class="login-card">
            <h1>ChatApp v2.0</h1>
            <p>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏£‡πâ‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•</p>
            <button class="google-btn" id="login-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
        </div>
    </div>

    <div id="app-container">
        
        <div class="sidebar">
            <div class="my-profile">
                <img id="my-avatar" class="avatar" src="">
                <div class="user-info" style="flex:1;">
                    <h3 id="my-name">...</h3>
                    <small style="color:var(--text-sec)"><span class="status-badge"></span>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</small>
                </div>
                <button onclick="ui.openProfile()" style="background:none; border:none; cursor:pointer;">‚öôÔ∏è</button>
                <button onclick="logic.logout()" style="background:none; border:none; cursor:pointer; font-size:12px; color:var(--red);">‡∏≠‡∏≠‡∏Å</button>
            </div>

            <div class="search-area">
                <div class="search-box">
                    <input type="text" id="add-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô..." onkeyup="if(event.key==='Enter') logic.addFriend()">
                    <button class="add-btn" onclick="logic.addFriend()">+</button>
                </div>
                <div id="add-err" class="err-msg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ</div>
            </div>

            <div style="padding: 0 15px; display:flex; justify-content:space-between; align-items:center;">
                <small style="color:#aaa;">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</small>
                <button onclick="ui.toggleRequests()" style="background:none; border:none; cursor:pointer; font-size:14px;">
                    üîî <span id="req-badge" class="badge-req hidden">0</span>
                </button>
            </div>

            <div id="friend-list" class="friend-list">
                </div>
        </div>

        <div class="chat-area">
            <div id="empty-state" style="height:100%; display:flex; justify-content:center; align-items:center; color:#aaa; flex-direction:column;">
                <div style="font-size:50px; margin-bottom:10px;">üí¨</div>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
            </div>

            <div id="active-chat-ui" class="hidden" style="display:flex; flex-direction:column; height:100%;">
                <div class="chat-header">
                    <div style="display:flex; align-items:center;">
                        <button class="back-btn" onclick="ui.goBack()">‚ùÆ</button>
                        <img id="chat-header-img" class="avatar" style="width:40px; height:40px; margin-right:10px;">
                        <div>
                            <h3 id="chat-header-name" style="margin:0; font-size:16px;">Friend</h3>
                            <small style="color:var(--green);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</small>
                        </div>
                    </div>
                    <div>
                        <button onclick="logic.callFriend()" style="background:none; border:none; font-size:20px; cursor:pointer;">üìû</button>
                        <button onclick="logic.blockFriend()" style="background:none; border:none; font-size:20px; cursor:pointer; color:orange;">üö´</button>
                        <button onclick="logic.deleteFriend()" style="background:none; border:none; font-size:20px; cursor:pointer; color:red;">üóëÔ∏è</button>
                    </div>
                </div>

                <div id="messages" class="messages"></div>
                
                <div id="blocked-bar" class="hidden" style="background:#eee; padding:15px; text-align:center; color:var(--red);">
                    ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
                </div>

                <div id="input-bar" class="input-bar">
                    <label for="file-input" class="attach-btn">üì∑</label>
                    <input type="file" id="file-input" accept="image/*" hidden onchange="logic.sendImage(this)">
                    <input type="text" id="msg-input" class="msg-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeyup="if(event.key==='Enter') logic.sendMessage()">
                    <button class="send-btn" onclick="logic.sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-box">
            <span class="close-btn" onclick="ui.closeModals()">√ó</span>
            <h2 style="margin-top:0;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
            
            <div style="text-align:center; margin-bottom:15px;">
                <img id="edit-preview" src="" style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:2px solid #ddd;">
                <br>
                <label for="avatar-upload" style="color:var(--primary-solid); cursor:pointer; font-size:14px;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                <input type="file" id="avatar-upload" accept="image/*" hidden onchange="logic.previewAvatar(this)">
            </div>

            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:</label>
            <input type="text" id="edit-name">
            <small style="color:#aaa;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏±‡∏ô</small>
            <div id="save-err" style="color:red; font-size:12px; margin-bottom:10px;"></div>
            
            <button class="save-btn" onclick="logic.saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
        </div>
    </div>

    <div id="req-modal" class="modal">
        <div class="modal-box">
            <span class="close-btn" onclick="ui.closeModals()">√ó</span>
            <h3>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
            <div id="req-list" style="max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="call-screen">
        <h2 id="call-txt">Incoming Call...</h2>
        <img id="call-u-img" class="call-pulse" src="">
        <h3 id="call-u-name" style="margin-top:20px;">User</h3>
        
        <div id="call-btns" class="call-actions">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, setDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // =======================================================
        //  ‚ö†Ô∏è‚ö†Ô∏è ‡πÉ‡∏™‡πà CONFIG ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) ‚ö†Ô∏è‚ö†Ô∏è
        // =======================================================
        const firebaseConfig = {
  apiKey: "AIzaSyB575txzpvEoiUPGAzMWmBIJ-AumUrPZ04",
  authDomain: "mychatapp-6553a.firebaseapp.com",
  databaseURL: "https://mychatapp-6553a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mychatapp-6553a",
  storageBucket: "mychatapp-6553a.firebasestorage.app",
  messagingSenderId: "327022378740",
  appId: "1:327022378740:web:325ea6d58ed16d5190e8a1",
  measurementId: "G-G7ECFJ2R3W"
};
        // =======================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentChatId = null;
        let currentFriendId = null;
        let unsubscribeChat = null;
        let tempAvatarBase64 = null; // Store temp image for profile save

        // --- UI Manager ---
        window.ui = {
            openProfile: () => {
                document.getElementById('profile-modal').style.display = 'flex';
                document.getElementById('edit-name').value = currentUser.name;
                document.getElementById('edit-preview').src = currentUser.avatar;
                tempAvatarBase64 = null; // Reset
                document.getElementById('save-err').textContent = '';
            },
            toggleRequests: () => document.getElementById('req-modal').style.display = 'flex',
            closeModals: () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'),
            
            // Mobile Navigation
            goChat: () => {
                document.body.classList.remove('view-list');
                document.body.classList.add('view-chat');
            },
            goBack: () => {
                document.body.classList.remove('view-chat');
                document.body.classList.add('view-list');
                currentChatId = null; // Reset chat selection
            },
            
            playSound: () => {
                const audio = document.getElementById('notif-sound');
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio play blocked"));
            }
        };

        // --- Logic Manager ---
        window.logic = {
            // 1. Auth & User
            login: async () => {
                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                } catch(e) { alert(e.message); }
            },
            logout: () => signOut(auth),
            
            initUser: async (user) => {
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);
                
                // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô DB
                if (!snap.exists()) {
                    await setDoc(userRef, {
                        name: user.displayName,
                        email: user.email,
                        avatar: user.photoURL, // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ Google
                        searchName: user.displayName.toLowerCase(),
                        lastRename: 0,
                        friends: [],
                        blocked: []
                    });
                } else if (!snap.data().avatar) {
                    // Fix ‡πÄ‡∏Å‡πà‡∏≤: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ user ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ avatar ‡πÉ‡∏´‡πâ update
                    await updateDoc(userRef, { avatar: user.photoURL });
                }

                // Realtime Listener
                onSnapshot(userRef, (doc) => {
                    currentUser = { uid: user.uid, ...doc.data() };
                    
                    document.getElementById('my-name').textContent = currentUser.name;
                    document.getElementById('my-avatar').src = currentUser.avatar;
                    
                    renderFriends(currentUser.friends || []);
                    renderRequests(currentUser.requests || []);
                    
                    // Check Incoming Call
                    if (currentUser.incomingCall) {
                        showIncomingCall(currentUser.incomingCall);
                    }
                });
            },

            // 2. Friends
            addFriend: async () => {
                const input = document.getElementById('add-input');
                const err = document.getElementById('add-err');
                const name = input.value.trim().toLowerCase();
                
                if (!name) return;
                err.style.display = 'none';

                if (name === currentUser.searchName) {
                    err.textContent = "‡πÅ‡∏≠‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
                    err.style.display = 'block';
                    return;
                }

                const q = query(collection(db, "users"), where("searchName", "==", name));
                const snap = await getDocs(q);

                if (snap.empty) {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
                    err.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ";
                    err.style.display = 'block';
                } else {
                    const target = snap.docs[0];
                    // Check if already friends
                    if (currentUser.friends.some(f => f.uid === target.id)) {
                        alert("‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß"); return;
                    }
                    
                    await updateDoc(doc(db, "users", target.id), {
                        requests: arrayUnion({
                            uid: currentUser.uid,
                            name: currentUser.name,
                            avatar: currentUser.avatar
                        })
                    });
                    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß!");
                    input.value = '';
                }
            },

            acceptReq: async (uid, name, pic) => {
                const chatRef = await addDoc(collection(db, "chats"), {
                    users: [currentUser.uid, uid],
                    createdAt: serverTimestamp()
                });
                
                // Add to me
                await updateDoc(doc(db, "users", currentUser.uid), {
                    friends: arrayUnion({ uid, name, avatar: pic, chatId: chatRef.id }),
                    requests: arrayRemove({ uid, name, avatar: pic })
                });
                // Add to friend
                await updateDoc(doc(db, "users", uid), {
                    friends: arrayUnion({ uid: currentUser.uid, name: currentUser.name, avatar: currentUser.avatar, chatId: chatRef.id })
                });
                ui.closeModals();
            },

            rejectReq: async (reqObj) => {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    requests: arrayRemove(reqObj)
                });
                // Re-render handled by onSnapshot
            },

            // 3. Profile Editing (with File Upload)
            previewAvatar: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Resize Logic (Canvas) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1MB
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 300; // ‡∏¢‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 300px ‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                            const scale = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scale;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            tempAvatarBase64 = canvas.toDataURL('image/jpeg', 0.8);
                            document.getElementById('edit-preview').src = tempAvatarBase64;
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            saveProfile: async () => {
                const newName = document.getElementById('edit-name').value.trim();
                const now = Date.now();
                const btn = document.querySelector('.save-btn');
                
                // Check 7 Days
                if (currentUser.lastRename && (now - currentUser.lastRename < 7*24*60*60*1000) && newName !== currentUser.name) {
                    document.getElementById('save-err').textContent = "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô";
                    return;
                }

                btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                btn.disabled = true;

                const updateData = {
                    name: newName,
                    searchName: newName.toLowerCase(),
                };
                if (newName !== currentUser.name) updateData.lastRename = now;
                if (tempAvatarBase64) updateData.avatar = tempAvatarBase64;

                await updateDoc(doc(db, "users", currentUser.uid), updateData);
                
                btn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
                btn.disabled = false;
                setTimeout(() => ui.closeModals(), 1000);
            },

            // 4. Chat System
            openChat: (fid, cid, name, av) => {
                currentFriendId = fid;
                currentChatId = cid;
                
                // UI Update
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('active-chat-ui').classList.remove('hidden');
                document.getElementById('chat-header-name').textContent = name;
                document.getElementById('chat-header-img').src = av;
                
                // Mobile View Switch
                ui.goChat();
                
                // Block Check
                const isBlocked = currentUser.blocked?.includes(fid);
                document.getElementById('input-bar').style.display = isBlocked ? 'none' : 'flex';
                document.getElementById('blocked-bar').classList.toggle('hidden', !isBlocked);

                // Messages Listener
                if (unsubscribeChat) unsubscribeChat();
                const q = query(collection(db, "chats", cid, "messages"), window.orderByFunc("timestamp", "asc"));
                
                unsubscribeChat = onSnapshot(collection(db, "chats", cid, "messages"), (snap) => {
                    const msgs = [];
                    snap.forEach(d => msgs.push(d.data()));
                    // Client-side sort fallback
                    msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    
                    renderMessages(msgs);
                    
                    // Sound Alert Logic
                    if (snap.docChanges().some(change => change.type === 'added')) {
                        const lastMsg = msgs[msgs.length - 1];
                        if (lastMsg && lastMsg.sender !== currentUser.uid) {
                            ui.playSound();
                        }
                    }
                });
            },

            sendMessage: async () => {
                const txt = document.getElementById('msg-input').value.trim();
                if(!txt) return;
                
                await addDoc(collection(db, "chats", currentChatId, "messages"), {
                    sender: currentUser.uid,
                    text: txt,
                    type: 'text',
                    timestamp: serverTimestamp()
                });
                document.getElementById('msg-input').value = '';
            },

            sendImage: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        // Limit size simple check
                        if (e.target.result.length > 800000) return alert("‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (limit 800KB)");
                        await addDoc(collection(db, "chats", currentChatId, "messages"), {
                            sender: currentUser.uid,
                            image: e.target.result,
                            type: 'image',
                            timestamp: serverTimestamp()
                        });
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            // 5. Block / Delete
            blockFriend: async () => {
                if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å/‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Å")) return;
                const isBlocked = currentUser.blocked?.includes(currentFriendId);
                const op = isBlocked ? arrayRemove(currentFriendId) : arrayUnion(currentFriendId);
                await updateDoc(doc(db, "users", currentUser.uid), { blocked: op });
            },

            deleteFriend: async () => {
                if(!confirm("‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?")) return;
                const fObj = currentUser.friends.find(f => f.uid === currentFriendId);
                await updateDoc(doc(db, "users", currentUser.uid), { friends: arrayRemove(fObj) });
                ui.goBack();
                document.getElementById('active-chat-ui').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
            },

            // 6. Calling System
            callFriend: async () => {
                // Show Calling UI (Outgoing)
                const screen = document.getElementById('call-screen');
                screen.style.display = 'flex';
                document.getElementById('call-txt').textContent = "Calling...";
                document.getElementById('call-u-name').textContent = document.getElementById('chat-header-name').textContent;
                document.getElementById('call-u-img').src = document.getElementById('chat-header-img').src;
                
                document.getElementById('call-btns').innerHTML = `
                    <button class="action-btn btn-reject" onclick="logic.cancelCall()">‚ùå</button>
                `;

                // Send Signal
                await updateDoc(doc(db, "users", currentFriendId), {
                    incomingCall: {
                        callerUid: currentUser.uid,
                        callerName: currentUser.name,
                        callerAvatar: currentUser.avatar
                    }
                });

                // Insert System Message
                await addDoc(collection(db, "chats", currentChatId, "messages"), {
                    sender: currentUser.uid,
                    text: "üìû ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£...",
                    type: 'system',
                    timestamp: serverTimestamp()
                });
            },

            cancelCall: async () => {
                document.getElementById('call-screen').style.display = 'none';
                // Clear signal on friend (optional, requires friend ID)
            },

            answerCall: async () => {
                document.getElementById('call-txt').textContent = "Connected";
                document.getElementById('call-btns').innerHTML = `
                    <button class="action-btn btn-reject" onclick="logic.endCall()">‚òé</button>
                `;
                // Clear Incoming state
                await updateDoc(doc(db, "users", currentUser.uid), { incomingCall: null });
            },

            endCall: async () => {
                document.getElementById('call-screen').style.display = 'none';
                await updateDoc(doc(db, "users", currentUser.uid), { incomingCall: null });
            }
        };

        // --- Render Helpers ---
        function renderFriends(list) {
            const container = document.getElementById('friend-list');
            container.innerHTML = '';
            list.forEach(f => {
                const div = document.createElement('div');
                div.className = `friend-item ${currentChatId === f.chatId ? 'active' : ''}`;
                div.onclick = () => logic.openChat(f.uid, f.chatId, f.name, f.avatar);
                div.innerHTML = `
                    <img src="${f.avatar}" class="avatar">
                    <div style="flex:1;">
                        <div style="font-weight:600;">${f.name}</div>
                        <small style="color:#aaa;">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏ó</small>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderRequests(list) {
            const container = document.getElementById('req-list');
            const badge = document.getElementById('req-badge');
            container.innerHTML = '';
            
            badge.textContent = list.length;
            badge.classList.toggle('hidden', list.length === 0);

            if (list.length === 0) container.innerHTML = "<p style='text-align:center; color:#999'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</p>";

            list.forEach(r => {
                const div = document.createElement('div');
                div.style = "display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;";
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${r.avatar}" style="width:40px; height:40px; border-radius:50%;">
                        <span>${r.name}</span>
                    </div>
                    <div>
                        <button onclick='window.logic.acceptReq("${r.uid}","${r.name}","${r.avatar}")' style="background:var(--green); color:white; border:none; padding:5px 10px; border-radius:5px;">‡∏£‡∏±‡∏ö</button>
                        <button onclick='window.logic.rejectReq(${JSON.stringify(r)})' style="background:#eee; border:none; padding:5px 10px; border-radius:5px;">‡∏•‡∏ö</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderMessages(msgs) {
            const div = document.getElementById('messages');
            div.innerHTML = '';
            msgs.forEach(m => {
                const el = document.createElement('div');
                if (m.type === 'system') {
                    el.style = "text-align:center; color:#aaa; font-size:12px; margin:10px 0;";
                    el.textContent = m.text;
                } else {
                    el.className = `message ${m.sender === currentUser.uid ? 'msg-me' : 'msg-friend'}`;
                    if (m.type === 'text') el.textContent = m.text;
                    if (m.type === 'image') el.innerHTML = `<img src="${m.image}" class="msg-img">`;
                }
                div.appendChild(el);
            });
            div.scrollTop = div.scrollHeight;
        }

        function showIncomingCall(callData) {
            const screen = document.getElementById('call-screen');
            screen.style.display = 'flex';
            document.getElementById('call-txt').textContent = "‡∏™‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤...";
            document.getElementById('call-u-name').textContent = callData.callerName;
            document.getElementById('call-u-img').src = callData.callerAvatar;
            
            document.getElementById('call-btns').innerHTML = `
                <button class="action-btn btn-answer" onclick="logic.answerCall()">üìû</button>
                <button class="action-btn btn-reject" onclick="logic.endCall()">‚ùå</button>
            `;
            
            // Auto play ringtone logic can go here
            ui.playSound();
        }

        // --- Event Binding ---
        document.getElementById('login-btn').onclick = logic.login;
        
        onAuthStateChanged(auth, u => {
            if (u) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                logic.initUser(u);
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        window.orderByFunc = (f, d) => { return null; }; // Mock for dev
    </script>
</body>
</html>